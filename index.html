<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Pericias Forenses</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { color: #2d3748; font-size: 24px; font-weight: 700; }
    .user-info { display: flex; align-items: center; gap: 20px; }
    .user-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
    }
    .user-badge.administrador { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .user-badge.supervisor { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .user-badge.encargado { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-danger { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
    .btn-warning { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; }
    .btn-secondary { background: #e2e8f0; color: #4a5568; }
    .btn-success { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab {
      background: white;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 400px;
      color: white;
      font-size: 18px;
    }
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .login-container { max-width: 400px; margin: 100px auto; }
    .login-card {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .login-title { font-size: 28px; font-weight: 700; text-align: center; color: #2d3748; margin-bottom: 30px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; }
    .form-control {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    .form-control:focus { outline: none; border-color: #667eea; }
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    .alert-error { background: #fed7d7; color: #c53030; border-left: 4px solid #f56565; }
    .alert-success { background: #c6f6d5; color: #2f855a; border-left: 4px solid #48bb78; }
    .alert-warning { background: #feebc8; color: #c05621; border-left: 4px solid #f6ad55; }
    .alert-info { background: #bee3f8; color: #2c5282; border-left: 4px solid #4299e1; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th {
      background: #f7fafc;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #4a5568;
      border-bottom: 2px solid #e2e8f0;
    }
    td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
    tr:hover { background: #f7fafc; cursor: pointer; }
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-pendiente { background: #fed7d7; color: #c53030; }
    .badge-en_proceso { background: #feebc8; color: #c05621; }
    .badge-contestada { background: #c6f6d5; color: #2f855a; }
    .badge-urgente { background: #f093fb; color: white; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .usuarios-selector {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      background: #f7fafc;
    }
    .usuarios-search { margin-bottom: 15px; }
    .usuarios-search input {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #cbd5e0;
      border-radius: 8px;
      font-size: 14px;
    }
    .usuarios-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: white;
      border-radius: 8px;
      margin-bottom: 15px;
      font-weight: 600;
      color: #4a5568;
    }
    .usuarios-por-turno { display: grid; gap: 15px; }
    .turno-group {
      background: white;
      border-radius: 10px;
      padding: 15px;
      border: 2px solid #e2e8f0;
    }
    .turno-header {
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .usuarios-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }
    .usuario-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      background: #f7fafc;
      border: 1px solid #e2e8f0;
    }
    .usuario-checkbox:hover { background: #edf2f7; border-color: #cbd5e0; }
    .usuario-checkbox.selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }
    .select-all-turno {
      font-size: 12px;
      padding: 4px 8px;
      background: transparent;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .select-all-turno:hover { background: #edf2f7; }
    .filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    select.form-control { width: auto; min-width: 150px; }
    .empty-state { text-align: center; padding: 60px 20px; color: #718096; }
    .empty-state-icon { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 15px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 30px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e2e8f0;
    }
    .modal-header h3 { font-size: 20px; color: #2d3748; }
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #718096;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    .close-btn:hover { background: #edf2f7; color: #2d3748; }
    .char-counter {
      text-align: right;
      font-size: 12px;
      color: #718096;
      margin-top: 5px;
    }
    .char-counter.error { color: #c53030; font-weight: 600; }
    .detalle-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e2e8f0;
    }
    .detalle-section:last-child { border-bottom: none; }
    .detalle-label {
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 5px;
    }
    .detalle-value { color: #2d3748; }
    .usuarios-asignados-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .usuario-asignado-item {
      padding: 8px 12px;
      background: #f7fafc;
      border-radius: 6px;
      font-size: 14px;
    }
    .usuario-asignado-item.contestado {
      background: #c6f6d5;
      border-left: 3px solid #48bb78;
    }
    .btn-group {
      display: flex;
      gap: 8px;
    }
    .contestacion-form {
      background: #f7fafc;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
    }
    .contestacion-item {
      margin-bottom: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border-left: 3px solid #667eea;
    }
    .contestacion-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 12px;
      color: #718096;
    }
    .mis-pericias-badge {
      background: #667eea;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ============================================
    // CONFIGURACI√ìN - Actualizar con tus credenciales
    // ============================================
    const SUPABASE_URL = 'https://dhpwdkysrjjsagtiqwmz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRocHdka3lzcmpqc2FndGlxd216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MDcwMTMsImV4cCI6MjA4NjQ4MzAxM30.L4j6986BRq7ghpleZFh3GJqt5MfaMsRBwTDP3Ubhm90';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================
    // CONSTANTES - Separadas correctamente
    // ============================================
    const TURNOS = [
      '1er Turno',
      '2do Turno',
      '3er Turno'
    ];

    const FISCALIAS = [
      'Fiscal√≠a 1er Turno',
      'Fiscal√≠a 2do Turno',
      'Fiscal√≠a 3er Turno',
      'Fiscal√≠a 4to Turno',
      'Fiscal√≠a 5to Turno',
      'Fiscal√≠a 1er Turno Delitos Sexuales',
      'Fiscal√≠a 2do Turno Delitos Sexuales',
      'Fiscal√≠a de Flagrancia',
      'Fiscal√≠a Especializada',
      'Otra'
    ];

    // ============================================
    // COMPONENTE: Login
    // ============================================
    function Login() {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        try {
          const { data: usuarioData, error: userError } = await supabase
            .from('usuarios')
            .select('email, activo')
            .eq('username', username)
            .single();

          if (userError || !usuarioData) throw new Error('Usuario no encontrado');
          if (!usuarioData.activo) throw new Error('Usuario inactivo. Contacte al administrador.');

          const { error } = await supabase.auth.signInWithPassword({
            email: usuarioData.email,
            password: password
          });

          if (error) throw error;
        } catch (err) {
          setError(err.message);
          setLoading(false);
        }
      };

      return (
        <div className="login-container">
          <div className="login-card">
            <h1 className="login-title">üî¨ Sistema de Pericias</h1>
            {error && <div className="alert alert-error">{error}</div>}
            <form onSubmit={handleSubmit}>
              <div className="form-group">
                <label className="form-label">Usuario</label>
                <input
                  type="text"
                  className="form-control"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  required
                  disabled={loading}
                  autoComplete="username"
                />
              </div>
              <div className="form-group">
                <label className="form-label">Contrase√±a</label>
                <input
                  type="password"
                  className="form-control"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  disabled={loading}
                  autoComplete="current-password"
                />
              </div>
              <button type="submit" className="btn btn-primary" style={{width: '100%'}} disabled={loading}>
                {loading ? '‚è≥ Iniciando sesi√≥n...' : 'üîë Ingresar'}
              </button>
            </form>
          </div>
        </div>
      );
    }

    // ============================================
    // COMPONENTE: Selector de Usuarios
    // ============================================
    function SelectorUsuarios({ usuarios, usuariosSeleccionados, onChange }) {
      const [busqueda, setBusqueda] = useState('');

      const usuariosFiltrados = useMemo(() => {
        if (!busqueda) return usuarios;
        return usuarios.filter(u => 
          u.nombre_completo.toLowerCase().includes(busqueda.toLowerCase()) ||
          u.username.toLowerCase().includes(busqueda.toLowerCase())
        );
      }, [usuarios, busqueda]);

      const usuariosPorTurno = useMemo(() => {
        const grupos = {
          '1er Turno': [],
          '2do Turno': [],
          '3er Turno': [],
          'Sin Turno': []
        };

        usuariosFiltrados.forEach(usuario => {
          const turno = usuario.turno || 'Sin Turno';
          if (grupos[turno]) {
            grupos[turno].push(usuario);
          } else {
            grupos['Sin Turno'].push(usuario);
          }
        });

        return grupos;
      }, [usuariosFiltrados]);

      const toggleUsuario = (userId) => {
        const nuevosSeleccionados = usuariosSeleccionados.includes(userId)
          ? usuariosSeleccionados.filter(id => id !== userId)
          : [...usuariosSeleccionados, userId];
        onChange(nuevosSeleccionados);
      };

      const seleccionarTodosTurno = (turno) => {
        const usuariosTurno = usuariosPorTurno[turno].map(u => u.id);
        const todosSeleccionados = usuariosTurno.every(id => usuariosSeleccionados.includes(id));
        
        if (todosSeleccionados) {
          onChange(usuariosSeleccionados.filter(id => !usuariosTurno.includes(id)));
        } else {
          const nuevos = [...new Set([...usuariosSeleccionados, ...usuariosTurno])];
          onChange(nuevos);
        }
      };

      return (
        <div className="usuarios-selector">
          <div className="usuarios-search">
            <input
              type="text"
              placeholder="üîç Buscar usuario..."
              value={busqueda}
              onChange={(e) => setBusqueda(e.target.value)}
            />
          </div>
          <div className="usuarios-stats">
            <span>üë• {usuariosSeleccionados.length} seleccionado(s)</span>
            <button type="button" className="btn btn-secondary" style={{fontSize: '12px', padding: '6px 12px'}} onClick={() => onChange([])}>
              Limpiar
            </button>
          </div>
          <div className="usuarios-por-turno">
            {Object.entries(usuariosPorTurno).map(([turno, usuariosTurno]) => {
              if (usuariosTurno.length === 0) return null;
              const todosSeleccionados = usuariosTurno.every(u => usuariosSeleccionados.includes(u.id));
              return (
                <div key={turno} className="turno-group">
                  <div className="turno-header">
                    <span>{turno}</span>
                    <div style={{display: 'flex', gap: '8px', alignItems: 'center'}}>
                      <span className="badge">{usuariosTurno.filter(u => usuariosSeleccionados.includes(u.id)).length}/{usuariosTurno.length}</span>
                      <button type="button" className="select-all-turno" onClick={() => seleccionarTodosTurno(turno)}>
                        {todosSeleccionados ? '‚úì Todos' : 'Seleccionar'}
                      </button>
                    </div>
                  </div>
                  <div className="usuarios-grid">
                    {usuariosTurno.map(usuario => (
                      <label key={usuario.id} className={`usuario-checkbox ${usuariosSeleccionados.includes(usuario.id) ? 'selected' : ''}`}>
                        <input
                          type="checkbox"
                          checked={usuariosSeleccionados.includes(usuario.id)}
                          onChange={() => toggleUsuario(usuario.id)}
                          style={{display: 'none'}}
                        />
                        <span style={{fontSize: '12px'}}>{usuario.nombre_completo}</span>
                      </label>
                    ))}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    // ============================================
    // COMPONENTE: Modal Detalle Pericia (con contestaci√≥n)
    // ============================================
    function ModalDetallePericia({ pericia, usuarioActual, onClose, onActualizar }) {
      const [usuariosAsignados, setUsuariosAsignados] = useState([]);
      const [contestaciones, setContestaciones] = useState([]);
      const [loading, setLoading] = useState(true);
      const [miContestacion, setMiContestacion] = useState('');
      const [enviando, setEnviando] = useState(false);
      const [error, setError] = useState('');
      const [yaContesto, setYaContesto] = useState(false);
      const [esAsignado, setEsAsignado] = useState(false);

      useEffect(() => {
        cargarDetalle();
      }, [pericia.id]);

      const cargarDetalle = async () => {
        try {
          const { data: asignacionesData } = await supabase
            .from('asignaciones')
            .select('usuario_id, usuarios(id, nombre_completo, turno)')
            .eq('pericia_id', pericia.id);

          const { data: contestacionesData } = await supabase
            .from('contestaciones')
            .select('*, usuarios(nombre_completo)')
            .eq('pericia_id', pericia.id)
            .order('created_at', { ascending: false });

          setUsuariosAsignados(asignacionesData || []);
          setContestaciones(contestacionesData || []);

          // Verificar si el usuario actual est√° asignado
          const asignado = asignacionesData?.some(a => a.usuario_id === usuarioActual.id);
          setEsAsignado(asignado);

          // Verificar si ya contest√≥
          const contesto = contestacionesData?.some(c => c.usuario_id === usuarioActual.id);
          setYaContesto(contesto);

        } catch (error) {
          console.error('Error:', error);
        } finally {
          setLoading(false);
        }
      };

      const handleEnviarContestacion = async () => {
        if (!miContestacion.trim()) {
          setError('La contestaci√≥n no puede estar vac√≠a');
          return;
        }

        if (miContestacion.trim().length < 10) {
          setError('La contestaci√≥n debe tener al menos 10 caracteres');
          return;
        }

        setEnviando(true);
        setError('');

        try {
          const { error: insertError } = await supabase
            .from('contestaciones')
            .insert({
              pericia_id: pericia.id,
              usuario_id: usuarioActual.id,
              contestacion: miContestacion.trim()
            });

          if (insertError) throw insertError;

          // Verificar si todos contestaron para actualizar estado
          const totalAsignados = usuariosAsignados.length;
          const totalContestaciones = contestaciones.length + 1;

          if (totalContestaciones >= totalAsignados) {
            await supabase
              .from('pericias')
              .update({ estado: 'contestada' })
              .eq('id', pericia.id);
          } else if (pericia.estado === 'pendiente') {
            await supabase
              .from('pericias')
              .update({ estado: 'en_proceso' })
              .eq('id', pericia.id);
          }

          setMiContestacion('');
          cargarDetalle();
          if (onActualizar) onActualizar();

        } catch (err) {
          setError('Error al enviar: ' + err.message);
        } finally {
          setEnviando(false);
        }
      };

      const diasRestantes = Math.ceil((new Date(pericia.plazo) - new Date()) / (1000 * 60 * 60 * 24));
      const usuariosQueContestaron = contestaciones.map(c => c.usuario_id);

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h3>üìã Pericia #{pericia.numero_sgsp}</h3>
              <button className="close-btn" onClick={onClose}>√ó</button>
            </div>

            {loading ? (
              <div style={{textAlign: 'center', padding: '20px'}}>
                <div className="spinner" style={{margin: '0 auto 10px', borderColor: '#667eea', borderTopColor: 'transparent'}}></div>
                Cargando...
              </div>
            ) : (
              <>
                <div className="detalle-section">
                  <div className="detalle-label">üìå Informaci√≥n General</div>
                  <p><strong>Turno:</strong> {pericia.turno}</p>
                  <p><strong>Fiscal√≠a:</strong> {pericia.fiscalia}</p>
                  <p><strong>Fecha:</strong> {new Date(pericia.fecha).toLocaleDateString('es-UY')} {pericia.hora}</p>
                  <p>
                    <strong>Plazo:</strong> {new Date(pericia.plazo).toLocaleDateString('es-UY')} 
                    <span style={{
                      color: diasRestantes <= 0 ? '#c53030' : diasRestantes <= 2 ? '#c05621' : '#2d3748',
                      marginLeft: '8px',
                      fontWeight: '600'
                    }}>
                      ({diasRestantes <= 0 ? '‚ö†Ô∏è VENCIDO' : `${diasRestantes} d√≠as restantes`} {diasRestantes <= 2 && diasRestantes > 0 ? 'üî•' : ''})
                    </span>
                  </p>
                  <p><strong>Estado:</strong> <span className={`badge badge-${pericia.estado}`}>{pericia.estado.replace('_', ' ')}</span></p>
                </div>

                <div className="detalle-section">
                  <div className="detalle-label">üìù Pericia Solicitada</div>
                  <div className="detalle-value" style={{whiteSpace: 'pre-wrap', background: '#f7fafc', padding: '15px', borderRadius: '8px'}}>
                    {pericia.pericia_solicitada}
                  </div>
                </div>

                {pericia.numero_novedad && (
                  <div className="detalle-section">
                    <div className="detalle-label">üî¢ N√∫mero de Novedad</div>
                    <div className="detalle-value">{pericia.numero_novedad}</div>
                  </div>
                )}

                <div className="detalle-section">
                  <div className="detalle-label">üë• Usuarios Asignados ({contestaciones.length}/{usuariosAsignados.length} contestaron)</div>
                  <div className="usuarios-asignados-list">
                    {usuariosAsignados.map((asig, idx) => {
                      const haContestado = usuariosQueContestaron.includes(asig.usuario_id);
                      return (
                        <div key={idx} className={`usuario-asignado-item ${haContestado ? 'contestado' : ''}`}>
                          {haContestado ? '‚úÖ' : '‚è≥'} {asig.usuarios?.nombre_completo}
                          {asig.usuarios?.turno && <div style={{fontSize: '11px', color: '#718096'}}>{asig.usuarios.turno}</div>}
                        </div>
                      );
                    })}
                  </div>
                </div>

                <div className="detalle-section">
                  <div className="detalle-label">üí¨ Contestaciones</div>
                  {contestaciones.length > 0 ? (
                    contestaciones.map((cont, idx) => (
                      <div key={idx} className="contestacion-item">
                        <div className="contestacion-header">
                          <span><strong>{cont.usuarios?.nombre_completo}</strong></span>
                          <span>{new Date(cont.created_at).toLocaleString('es-UY')}</span>
                        </div>
                        <div style={{whiteSpace: 'pre-wrap'}}>{cont.contestacion}</div>
                      </div>
                    ))
                  ) : (
                    <div style={{color: '#718096', fontStyle: 'italic', padding: '20px', textAlign: 'center', background: '#f7fafc', borderRadius: '8px'}}>
                      üì≠ Sin contestaciones a√∫n
                    </div>
                  )}
                </div>

                {/* Formulario de contestaci√≥n - solo para usuarios asignados que no han contestado */}
                {esAsignado && !yaContesto && pericia.estado !== 'contestada' && (
                  <div className="contestacion-form">
                    <div className="detalle-label">‚úçÔ∏è Tu Contestaci√≥n</div>
                    {error && <div className="alert alert-error">{error}</div>}
                    <textarea
                      className="form-control"
                      rows="5"
                      placeholder="Escribe tu contestaci√≥n aqu√≠..."
                      value={miContestacion}
                      onChange={(e) => setMiContestacion(e.target.value)}
                      disabled={enviando}
                      style={{marginBottom: '10px'}}
                    />
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                      <span style={{fontSize: '12px', color: '#718096'}}>{miContestacion.length} caracteres</span>
                      <button 
                        className="btn btn-success" 
                        onClick={handleEnviarContestacion}
                        disabled={enviando || miContestacion.trim().length < 10}
                      >
                        {enviando ? '‚è≥ Enviando...' : 'üì§ Enviar Contestaci√≥n'}
                      </button>
                    </div>
                  </div>
                )}

                {esAsignado && yaContesto && (
                  <div className="alert alert-success">
                    ‚úÖ Ya has enviado tu contestaci√≥n para esta pericia.
                  </div>
                )}
              </>
            )}
          </div>
        </div>
      );
    }

    // ============================================
    // COMPONENTE: Lista de Pericias
    // ============================================
    function ListaPericias({ pericias, esArchivadas, usuarioActual, onVerDetalle, onArchivar, onEliminar, onRestaurar }) {
      if (pericias.length === 0) {
        return (
          <div className="card">
            <div className="empty-state">
              <div className="empty-state-icon">üì≠</div>
              <h3>No hay pericias</h3>
              <p style={{marginTop: '10px', color: '#a0aec0'}}>
                {esArchivadas ? 'No hay pericias archivadas' : 'Las pericias aparecer√°n aqu√≠'}
              </p>
            </div>
          </div>
        );
      }

      const esAdmin = usuarioActual.rol === 'administrador';

      return (
        <div className="card">
          <div className="table-container">
            <table>
              <thead>
                <tr>
                  <th>N¬∞ SGSP</th>
                  <th>Turno</th>
                  <th>Fecha</th>
                  <th>Pericia</th>
                  <th>Plazo</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {pericias.map(pericia => {
                  const diasRestantes = Math.ceil((new Date(pericia.plazo) - new Date()) / (1000 * 60 * 60 * 24));
                  const esUrgente = diasRestantes <= 2 && pericia.estado !== 'contestada';

                  return (
                    <tr key={pericia.id} onClick={() => onVerDetalle(pericia)}>
                      <td><strong>{pericia.numero_sgsp}</strong></td>
                      <td><span className="badge">{pericia.turno}</span></td>
                      <td>{new Date(pericia.fecha).toLocaleDateString('es-UY')}</td>
                      <td style={{maxWidth: '250px'}}>
                        {pericia.pericia_solicitada.substring(0, 60)}
                        {pericia.pericia_solicitada.length > 60 ? '...' : ''}
                      </td>
                      <td>
                        {new Date(pericia.plazo).toLocaleDateString('es-UY')}
                        {esUrgente && <span className="badge badge-urgente" style={{marginLeft: '8px'}}>üî•</span>}
                      </td>
                      <td>
                        <span className={`badge badge-${pericia.estado}`}>
                          {pericia.estado.charAt(0).toUpperCase() + pericia.estado.slice(1).replace('_', ' ')}
                        </span>
                      </td>
                      <td onClick={(e) => e.stopPropagation()}>
                        <div className="btn-group">
                          <button 
                            className="btn btn-primary" 
                            style={{fontSize: '12px', padding: '6px 12px'}} 
                            onClick={() => onVerDetalle(pericia)}
                          >
                            üëÅÔ∏è Ver
                          </button>
                          {onArchivar && esAdmin && (
                            <button 
                              className="btn btn-warning" 
                              style={{fontSize: '12px', padding: '6px 12px'}} 
                              onClick={() => onArchivar(pericia.id)}
                            >
                              üì¶
                            </button>
                          )}
                          {onEliminar && esAdmin && (
                            <button 
                              className="btn btn-danger" 
                              style={{fontSize: '12px', padding: '6px 12px'}} 
                              onClick={() => onEliminar(pericia.id, pericia.numero_sgsp)}
                            >
                              üóëÔ∏è
                            </button>
                          )}
                          {onRestaurar && esAdmin && (
                            <button 
                              className="btn btn-success" 
                              style={{fontSize: '12px', padding: '6px 12px'}} 
                              onClick={() => onRestaurar(pericia.id)}
                            >
                              ‚Ü©Ô∏è
                            </button>
                          )}
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    // ============================================
    // COMPONENTE: Formulario Nueva Pericia
    // ============================================
    function FormularioPericia({ usuarios, usuarioActual, onSuccess }) {
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [formData, setFormData] = useState({
        fecha: new Date().toISOString().split('T')[0],
        hora: new Date().toTimeString().slice(0,5),
        numero_sgsp: '',
        pericia_solicitada: '',
        fiscalia: '',
        plazo: '',
        numero_novedad: '',
        turno: usuarioActual.turno || '1er Turno',
        usuarios_asignados: []
      });

      const contadorChars = formData.pericia_solicitada.length;
      const esValido = contadorChars >= 20 && contadorChars <= 5000;

      // Filtrar usuarios seg√∫n el rol del usuario actual
      const usuariosDisponibles = useMemo(() => {
        if (['administrador', 'supervisor'].includes(usuarioActual.rol)) {
          return usuarios;
        }
        // Encargado solo ve usuarios de su turno
        if (usuarioActual.rol === 'encargado' && usuarioActual.turno) {
          return usuarios.filter(u => u.turno === usuarioActual.turno || !u.turno);
        }
        return [];
      }, [usuarios, usuarioActual]);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        const descripcion = formData.pericia_solicitada.trim();
        
        if (descripcion.length < 20) {
          setError('La descripci√≥n debe tener al menos 20 caracteres');
          setLoading(false);
          return;
        }

        if (descripcion.length > 5000) {
          setError('La descripci√≥n no puede exceder 5000 caracteres');
          setLoading(false);
          return;
        }

        if (formData.usuarios_asignados.length === 0) {
          setError('Debe asignar al menos un usuario');
          setLoading(false);
          return;
        }

        if (!formData.fiscalia) {
          setError('Debe seleccionar una fiscal√≠a');
          setLoading(false);
          return;
        }

        if (!formData.plazo) {
          setError('Debe establecer un plazo');
          setLoading(false);
          return;
        }

        try {
          const { data: { user } } = await supabase.auth.getUser();

          const { data: pericia, error: periciaError } = await supabase
            .from('pericias')
            .insert({
              fecha: formData.fecha,
              hora: formData.hora,
              numero_sgsp: formData.numero_sgsp,
              pericia_solicitada: descripcion,
              fiscalia: formData.fiscalia,
              plazo: formData.plazo,
              numero_novedad: formData.numero_novedad || null,
              turno: formData.turno,
              creado_por: user.id,
              estado: 'pendiente'
            })
            .select()
            .single();

          if (periciaError) throw periciaError;

          const asignaciones = formData.usuarios_asignados.map(userId => ({
            pericia_id: pericia.id,
            usuario_id: userId
          }));

          const { error: asignacionError } = await supabase
            .from('asignaciones')
            .insert(asignaciones);

          if (asignacionError) throw asignacionError;

          alert('‚úÖ Pericia creada exitosamente');
          onSuccess();
        } catch (err) {
          setError('Error: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      // Verificar permisos para crear
      const puedeCrear = ['administrador', 'supervisor', 'encargado'].includes(usuarioActual.rol);

      if (!puedeCrear) {
        return (
          <div className="card">
            <div className="alert alert-warning">
              ‚ö†Ô∏è No tienes permisos para crear pericias. Solo administradores, supervisores y encargados pueden crear nuevas solicitudes.
            </div>
          </div>
        );
      }

      return (
        <div className="card">
          <h2>‚ûï Nueva Solicitud de Pericia</h2>
          {error && <div className="alert alert-error">{error}</div>}

          <form onSubmit={handleSubmit}>
            <div className="form-row">
              <div className="form-group">
                <label className="form-label">Fecha *</label>
                <input 
                  type="date" 
                  className="form-control" 
                  value={formData.fecha} 
                  onChange={(e) => setFormData({...formData, fecha: e.target.value})} 
                  required 
                />
              </div>
              <div className="form-group">
                <label className="form-label">Hora *</label>
                <input 
                  type="time" 
                  className="form-control" 
                  value={formData.hora} 
                  onChange={(e) => setFormData({...formData, hora: e.target.value})} 
                  required 
                />
              </div>
              <div className="form-group">
                <label className="form-label">N√∫mero SGSP *</label>
                <input 
                  type="text" 
                  className="form-control" 
                  value={formData.numero_sgsp} 
                  onChange={(e) => setFormData({...formData, numero_sgsp: e.target.value})} 
                  required 
                  placeholder="Ej: 2024-001234"
                />
              </div>
            </div>

            <div className="form-row">
              <div className="form-group">
                <label className="form-label">Turno *</label>
                <select 
                  className="form-control" 
                  value={formData.turno} 
                  onChange={(e) => setFormData({...formData, turno: e.target.value})} 
                  required
                  disabled={usuarioActual.rol === 'encargado' && usuarioActual.turno}
                >
                  {TURNOS.map(t => <option key={t} value={t}>{t}</option>)}
                </select>
                {usuarioActual.rol === 'encargado' && usuarioActual.turno && (
                  <small style={{color: '#718096', fontSize: '11px'}}>Solo puedes crear pericias para tu turno</small>
                )}
              </div>
              <div className="form-group">
                <label className="form-label">Fiscal√≠a *</label>
                <select 
                  className="form-control" 
                  value={formData.fiscalia} 
                  onChange={(e) => setFormData({...formData, fiscalia: e.target.value})} 
                  required
                >
                  <option value="">Seleccionar...</option>
                  {FISCALIAS.map(f => <option key={f} value={f}>{f}</option>)}
                </select>
              </div>
              <div className="form-group">
                <label className="form-label">Plazo *</label>
                <input 
                  type="date" 
                  className="form-control" 
                  value={formData.plazo} 
                  onChange={(e) => setFormData({...formData, plazo: e.target.value})} 
                  required
                  min={new Date().toISOString().split('T')[0]}
                />
              </div>
            </div>

            <div className="form-group">
              <label className="form-label">Pericia Solicitada *</label>
              <textarea 
                className="form-control" 
                rows="5" 
                value={formData.pericia_solicitada} 
                onChange={(e) => setFormData({...formData, pericia_solicitada: e.target.value})} 
                required 
                placeholder="Describa detalladamente la pericia solicitada (m√≠nimo 20 caracteres)..."
              />
              <div className={`char-counter ${!esValido && contadorChars > 0 ? 'error' : ''}`}>
                {contadorChars} / 5000 caracteres
                {contadorChars > 0 && contadorChars < 20 && <span> - ‚ö†Ô∏è M√≠nimo 20 caracteres</span>}
              </div>
            </div>

            <div className="form-group">
              <label className="form-label">N√∫mero de Novedad (opcional)</label>
              <input 
                type="text" 
                className="form-control" 
                value={formData.numero_novedad} 
                onChange={(e) => setFormData({...formData, numero_novedad: e.target.value})}
                placeholder="Si aplica..."
              />
            </div>

            <div className="form-group">
              <label className="form-label">Asignar Usuarios * ({formData.usuarios_asignados.length} seleccionados)</label>
              <SelectorUsuarios
                usuarios={usuariosDisponibles}
                usuariosSeleccionados={formData.usuarios_asignados}
                onChange={(seleccionados) => setFormData({...formData, usuarios_asignados: seleccionados})}
              />
            </div>

            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
              <button type="submit" className="btn btn-primary" disabled={loading || !esValido}>
                {loading ? '‚è≥ Guardando...' : '‚úÖ Crear Pericia'}
              </button>
              <button type="button" className="btn btn-secondary" onClick={() => window.location.reload()}>
                Cancelar
              </button>
            </div>
          </form>
        </div>
      );
    }

    // ============================================
    // COMPONENTE: Modal Editar Usuario
    // ============================================
    function ModalEditarUsuario({ usuario, onClose, onGuardar }) {
      const [rol, setRol] = useState(usuario.rol);
      const [turno, setTurno] = useState(usuario.turno || '');
      const [activo, setActivo] = useState(usuario.activo);
      const [nombreCompleto, setNombreCompleto] = useState(usuario.nombre_completo);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleGuardar = async () => {
        setLoading(true);
        setError('');

        try {
          const turnoFinal = ['administrador', 'supervisor'].includes(rol) ? null : turno || null;

          const { error: updateError } = await supabase
            .from('usuarios')
            .update({
              rol: rol,
              turno: turnoFinal,
              activo: activo,
              nombre_completo: nombreCompleto
            })
            .eq('id', usuario.id);

          if (updateError) throw updateError;
          onGuardar();
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const esAdminOSupervisor = ['administrador', 'supervisor'].includes(rol);

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h3>‚úèÔ∏è Editar Usuario</h3>
              <button className="close-btn" onClick={onClose}>√ó</button>
            </div>

            {error && <div className="alert alert-error">{error}</div>}

            <div className="form-group">
              <label className="form-label">Usuario</label>
              <input type="text" className="form-control" value={usuario.username} disabled style={{background: '#f7fafc'}} />
            </div>

            <div className="form-group">
              <label className="form-label">Email</label>
              <input type="text" className="form-control" value={usuario.email} disabled style={{background: '#f7fafc'}} />
            </div>

            <div className="form-group">
              <label className="form-label">Nombre Completo</label>
              <input 
                type="text" 
                className="form-control" 
                value={nombreCompleto} 
                onChange={(e) => setNombreCompleto(e.target.value)}
                required
              />
            </div>

            <div className="form-group">
              <label className="form-label">Rol</label>
              <select className="form-control" value={rol} onChange={(e) => setRol(e.target.value)}>
                <option value="administrador">üëë Administrador</option>
                <option value="supervisor">üëÅÔ∏è Supervisor</option>
                <option value="encargado">üéñÔ∏è Encargado</option>
                <option value="usuario">üë§ Usuario</option>
              </select>
            </div>

            {!esAdminOSupervisor && (
              <div className="form-group">
                <label className="form-label">Turno</label>
                <select className="form-control" value={turno} onChange={(e) => setTurno(e.target.value)}>
                  <option value="">Sin turno asignado</option>
                  {TURNOS.map(t => <option key={t} value={t}>{t}</option>)}
                </select>
              </div>
            )}

            {esAdminOSupervisor && (
              <div className="alert alert-info">
                ‚ÑπÔ∏è Administradores y Supervisores ven todos los turnos
              </div>
            )}

            <div className="form-group">
              <label style={{display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer'}}>
                <input 
                  type="checkbox" 
                  checked={activo} 
                  onChange={(e) => setActivo(e.target.checked)} 
                  style={{width: '18px', height: '18px'}} 
                />
                <span className="form-label" style={{marginBottom: 0}}>Usuario Activo</span>
              </label>
            </div>

            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
              <button className="btn btn-success" onClick={handleGuardar} disabled={loading} style={{flex: 1}}>
                {loading ? '‚è≥ Guardando...' : 'üíæ Guardar'}
              </button>
              <button className="btn btn-secondary" onClick={onClose} disabled={loading}>Cancelar</button>
            </div>
          </div>
        </div>
      );
    }

    // ============================================
    // COMPONENTE: Gesti√≥n de Usuarios
    // ============================================
    function GestionUsuarios({ usuarios, onRecargar }) {
      const [usuarioEditar, setUsuarioEditar] = useState(null);

      return (
        <div className="card">
          <h2>üë• Gesti√≥n de Usuarios ({usuarios.length})</h2>
          <div className="table-container">
            <table>
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Nombre</th>
                  <th>Email</th>
                  <th>Rol</th>
                  <th>Turno</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {usuarios.map(usuario => (
                  <tr key={usuario.id}>
                    <td><strong>{usuario.username}</strong></td>
                    <td>{usuario.nombre_completo}</td>
                    <td style={{fontSize: '12px', color: '#718096'}}>{usuario.email}</td>
                    <td><span className={`user-badge ${usuario.rol}`}>{usuario.rol}</span></td>
                    <td>{usuario.turno || <span style={{color: '#a0aec0'}}>Todos</span>}</td>
                    <td>
                      <span className={`badge ${usuario.activo ? 'badge-contestada' : 'badge-pendiente'}`}>
                        {usuario.activo ? '‚úì Activo' : '‚úó Inactivo'}
                      </span>
                    </td>
                    <td>
                      <button 
                        className="btn btn-primary" 
                        style={{fontSize: '12px', padding: '6px 12px'}} 
                        onClick={() => setUsuarioEditar(usuario)}
                      >
                        ‚úèÔ∏è Editar
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {usuarioEditar && (
            <ModalEditarUsuario
              usuario={usuarioEditar}
              onClose={() => setUsuarioEditar(null)}
              onGuardar={() => {
                setUsuarioEditar(null);
                onRecargar();
                alert('‚úÖ Usuario actualizado');
              }}
            />
          )}
        </div>
      );
    }

    // ============================================
    // COMPONENTE PRINCIPAL: App
    // ============================================
    function App() {
      const [user, setUser] = useState(null);
      const [usuarioActual, setUsuarioActual] = useState(null);
      const [loading, setLoading] = useState(true);
      const [vistaActual, setVistaActual] = useState('pendientes');
      const [pericias, setPericias] = useState([]);
      const [usuarios, setUsuarios] = useState([]);
      const [filtroTurno, setFiltroTurno] = useState('todos');
      const [periciaDetalle, setPericiaDetalle] = useState(null);

      useEffect(() => {
        const cachedUser = localStorage.getItem('usuarioActual');
        if (cachedUser) {
          try {
            setUsuarioActual(JSON.parse(cachedUser));
          } catch (e) {
            localStorage.removeItem('usuarioActual');
          }
        }

        const init = async () => {
          try {
            const timeoutId = setTimeout(() => {
              console.error('Timeout detectado - limpiando localStorage');
              localStorage.clear();
              window.location.reload();
            }, 15000);

            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            
            clearTimeout(timeoutId);

            if (sessionError) {
              console.error('Error de sesi√≥n:', sessionError);
              localStorage.clear();
              setLoading(false);
              return;
            }
            
            if (session?.user) {
              setUser(session.user);
              
              const { data: userData, error: userError } = await supabase
                .from('usuarios')
                .select('*')
                .eq('id', session.user.id)
                .maybeSingle();
              
              if (userError) {
                console.error('Error al cargar usuario:', userError);
                localStorage.clear();
                await supabase.auth.signOut();
                setLoading(false);
                return;
              }

              if (userData) {
                setUsuarioActual(userData);
                localStorage.setItem('usuarioActual', JSON.stringify(userData));
              }
            }
          } catch (error) {
            console.error('Error en init:', error);
            localStorage.clear();
          } finally {
            setLoading(false);
          }
        };

        init();

        const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
          if (event === 'SIGNED_IN' && session?.user) {
            setUser(session.user);
            const { data: userData } = await supabase.from('usuarios').select('*').eq('id', session.user.id).maybeSingle();
            if (userData) {
              setUsuarioActual(userData);
              localStorage.setItem('usuarioActual', JSON.stringify(userData));
            }
          } else if (event === 'SIGNED_OUT') {
            setUser(null);
            setUsuarioActual(null);
            localStorage.clear();
          }
        });

        return () => subscription?.unsubscribe();
      }, []);

      useEffect(() => {
        if (user && usuarioActual) {
          cargarDatos();
        }
      }, [user, usuarioActual, vistaActual, filtroTurno]);

      const cargarDatos = async () => {
        try {
          let query = supabase.from('pericias').select('*');

          if (vistaActual !== 'archivadas') {
            query = query.is('deleted_at', null);
          } else {
            query = query.not('deleted_at', 'is', null);
          }

          if (vistaActual === 'pendientes') {
            query = query.in('estado', ['pendiente', 'en_proceso']);
          } else if (vistaActual === 'contestadas') {
            query = query.eq('estado', 'contestada');
          }

          // Filtrar por turno seg√∫n rol
          if (usuarioActual.rol === 'encargado' && usuarioActual.turno) {
            query = query.eq('turno', usuarioActual.turno);
          } else if (usuarioActual.rol === 'usuario') {
            const { data: misAsignaciones } = await supabase
              .from('asignaciones')
              .select('pericia_id')
              .eq('usuario_id', user.id);
            
            const periciaIds = misAsignaciones?.map(a => a.pericia_id) || [];
            if (periciaIds.length > 0) {
              query = query.in('id', periciaIds);
            } else {
              query = query.eq('id', '00000000-0000-0000-0000-000000000000');
            }
          }

          // Filtro adicional por turno para admin/supervisor
          if (filtroTurno !== 'todos' && ['administrador', 'supervisor'].includes(usuarioActual.rol)) {
            query = query.eq('turno', filtroTurno);
          }

          const { data: periciasData } = await query.order('created_at', { ascending: false });
          setPericias(periciasData || []);

          // Cargar usuarios si tiene permisos
          if (['administrador', 'supervisor', 'encargado'].includes(usuarioActual.rol)) {
            let usuariosQuery = supabase.from('usuarios').select('*');
            
            if (vistaActual !== 'usuarios') {
              usuariosQuery = usuariosQuery.eq('activo', true);
            }
            
            const { data: usuariosData } = await usuariosQuery.order('nombre_completo');
            setUsuarios(usuariosData || []);
          }
        } catch (error) {
          console.error('Error:', error);
        }
      };

      const handleLogout = async () => {
        await supabase.auth.signOut();
        localStorage.clear();
        window.location.reload();
      };

      const handleArchivarPericia = async (periciaId) => {
        const motivo = prompt('Motivo del archivo (ser√° registrado en auditor√≠a):');
        if (!motivo || !motivo.trim()) {
          alert('Debe ingresar un motivo para archivar');
          return;
        }

        try {
          // Intentar con RPC primero
          const { data, error } = await supabase.rpc('soft_delete_pericia', {
            p_pericia_id: periciaId,
            p_motivo: motivo.trim()
          });

          if (error) {
            // Si falla RPC, intentar update directo
            const { error: updateError } = await supabase
              .from('pericias')
              .update({ 
                deleted_at: new Date().toISOString(),
                deleted_by: user.id,
                delete_reason: motivo.trim()
              })
              .eq('id', periciaId);
            
            if (updateError) throw updateError;
          } else if (data && !data.success) {
            throw new Error(data.error);
          }

          alert('‚úÖ Pericia archivada correctamente');
          cargarDatos();
        } catch (error) {
          alert('‚ùå Error: ' + error.message);
        }
      };

      const handleEliminarFisico = async (periciaId, numeroSgsp) => {
        if (!confirm(`‚ö†Ô∏è ADVERTENCIA ‚ö†Ô∏è\n\nEst√°s a punto de ELIMINAR PERMANENTEMENTE la pericia #${numeroSgsp}.\n\nEsta acci√≥n NO SE PUEDE DESHACER.\n\n¬øEst√°s COMPLETAMENTE SEGURO?`)) {
          return;
        }

        const confirmacion = prompt('Para confirmar, escribe ELIMINAR en may√∫sculas:');
        if (confirmacion !== 'ELIMINAR') {
          alert('Eliminaci√≥n cancelada');
          return;
        }

        try {
          // Intentar con RPC para bypass de RLS
          const { data, error } = await supabase.rpc('hard_delete_pericia', {
            p_pericia_id: periciaId
          });

          if (error) {
            // Si no existe la funci√≥n RPC, eliminar manualmente
            // Primero eliminar asignaciones
            await supabase.from('asignaciones').delete().eq('pericia_id', periciaId);
            
            // Luego contestaciones
            await supabase.from('contestaciones').delete().eq('pericia_id', periciaId);
            
            // Finalmente la pericia
            const { error: deleteError } = await supabase
              .from('pericias')
              .delete()
              .eq('id', periciaId);

            if (deleteError) throw deleteError;
          } else if (data && !data.success) {
            throw new Error(data.error);
          }

          alert('‚úÖ Pericia eliminada permanentemente');
          cargarDatos();
        } catch (error) {
          console.error('Error al eliminar:', error);
          alert('‚ùå Error al eliminar: ' + error.message + '\n\nEs posible que necesites crear la funci√≥n RPC en Supabase o ajustar las pol√≠ticas RLS.');
        }
      };

      const handleRestaurarPericia = async (periciaId) => {
        if (!confirm('¬øRestaurar esta pericia?')) return;

        try {
          const { data, error } = await supabase.rpc('restore_pericia', {
            p_pericia_id: periciaId
          });

          if (error) {
            // Si no existe RPC, intentar update directo
            const { error: updateError } = await supabase
              .from('pericias')
              .update({ 
                deleted_at: null,
                deleted_by: null,
                delete_reason: null
              })
              .eq('id', periciaId);
            
            if (updateError) throw updateError;
          } else if (data && !data.success) {
            throw new Error(data.error);
          }

          alert('‚úÖ Pericia restaurada');
          cargarDatos();
        } catch (error) {
          alert('‚ùå Error: ' + error.message);
        }
      };

      if (loading) {
        return (
          <div className="loading">
            <div className="spinner"></div>
            Cargando sistema...
          </div>
        );
      }

      if (!user || !usuarioActual) return <Login />;

      const esAdmin = usuarioActual.rol === 'administrador';
      const esSupervisor = usuarioActual.rol === 'supervisor';
      const esEncargado = usuarioActual.rol === 'encargado';
      const puedeCrear = esAdmin || esSupervisor || esEncargado;

      return (
        <div className="container">
          <div className="header">
            <h1>üî¨ Sistema de Pericias Forenses</h1>
            <div className="user-info">
              <div className={`user-badge ${usuarioActual.rol}`}>
                {usuarioActual.rol === 'administrador' && 'üëë'}
                {usuarioActual.rol === 'supervisor' && 'üëÅÔ∏è'}
                {usuarioActual.rol === 'encargado' && 'üéñÔ∏è'}
                {usuarioActual.rol === 'usuario' && 'üë§'}
                {' '}{usuarioActual.nombre_completo}
                <span style={{opacity: 0.8, marginLeft: '5px'}}>
                  ({usuarioActual.rol}{usuarioActual.turno ? ` - ${usuarioActual.turno}` : ''})
                </span>
              </div>
              <button className="btn btn-secondary" onClick={handleLogout}>üö™ Salir</button>
            </div>
          </div>

          <div className="tabs">
            <div className={`tab ${vistaActual === 'pendientes' ? 'active' : ''}`} onClick={() => setVistaActual('pendientes')}>
              üì• Pendientes
            </div>
            <div className={`tab ${vistaActual === 'contestadas' ? 'active' : ''}`} onClick={() => setVistaActual('contestadas')}>
              ‚úÖ Contestadas
            </div>
            {puedeCrear && (
              <div className={`tab ${vistaActual === 'nueva' ? 'active' : ''}`} onClick={() => setVistaActual('nueva')}>
                ‚ûï Nueva
              </div>
            )}
            {(esAdmin || esSupervisor) && (
              <div className={`tab ${vistaActual === 'todas' ? 'active' : ''}`} onClick={() => setVistaActual('todas')}>
                üìä Todas
              </div>
            )}
            {esAdmin && (
              <div className={`tab ${vistaActual === 'archivadas' ? 'active' : ''}`} onClick={() => setVistaActual('archivadas')}>
                üóëÔ∏è Archivadas
              </div>
            )}
            {esAdmin && (
              <div className={`tab ${vistaActual === 'usuarios' ? 'active' : ''}`} onClick={() => setVistaActual('usuarios')}>
                üë• Usuarios
              </div>
            )}
          </div>

          {(esAdmin || esSupervisor) && ['pendientes', 'contestadas', 'todas', 'archivadas'].includes(vistaActual) && (
            <div className="filters">
              <select className="form-control" value={filtroTurno} onChange={(e) => setFiltroTurno(e.target.value)}>
                <option value="todos">üîç Todos los turnos</option>
                {TURNOS.map(t => <option key={t} value={t}>{t}</option>)}
              </select>
              <span style={{color: 'white', alignSelf: 'center'}}>
                {pericias.length} pericia(s) encontrada(s)
              </span>
            </div>
          )}

          {['pendientes', 'contestadas', 'todas', 'archivadas'].includes(vistaActual) && (
            <ListaPericias
              pericias={pericias}
              esArchivadas={vistaActual === 'archivadas'}
              usuarioActual={usuarioActual}
              onVerDetalle={(p) => setPericiaDetalle(p)}
              onArchivar={esAdmin && vistaActual !== 'archivadas' ? handleArchivarPericia : null}
              onEliminar={esAdmin ? handleEliminarFisico : null}
              onRestaurar={esAdmin && vistaActual === 'archivadas' ? handleRestaurarPericia : null}
            />
          )}

          {vistaActual === 'nueva' && puedeCrear && (
            <FormularioPericia
              usuarios={usuarios}
              usuarioActual={usuarioActual}
              onSuccess={() => {
                cargarDatos();
                setVistaActual('pendientes');
              }}
            />
          )}

          {vistaActual === 'usuarios' && esAdmin && (
            <GestionUsuarios usuarios={usuarios} onRecargar={cargarDatos} />
          )}

          {periciaDetalle && (
            <ModalDetallePericia
              pericia={periciaDetalle}
              usuarioActual={usuarioActual}
              onClose={() => setPericiaDetalle(null)}
              onActualizar={cargarDatos}
            />
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
