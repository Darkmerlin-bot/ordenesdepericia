<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Pericias Forenses</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      color: #2d3748;
      font-size: 24px;
      font-weight: 700;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .user-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
    }

    .user-badge.admin {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .user-badge.supervisor {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .user-badge.encargado {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab {
      background: white;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 400px;
      color: white;
      font-size: 18px;
    }

    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .login-container {
      max-width: 400px;
      margin: 100px auto;
    }

    .login-card {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .login-title {
      font-size: 28px;
      font-weight: 700;
      text-align: center;
      color: #2d3748;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #4a5568;
    }

    .form-control {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-control:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .alert-error {
      background: #fed7d7;
      color: #c53030;
      border-left: 4px solid #f56565;
    }

    .alert-success {
      background: #c6f6d5;
      color: #2f855a;
      border-left: 4px solid #48bb78;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #f7fafc;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #4a5568;
      border-bottom: 2px solid #e2e8f0;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
    }

    tr:hover {
      background: #f7fafc;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-pendiente {
      background: #fed7d7;
      color: #c53030;
    }

    .badge-en-proceso {
      background: #feebc8;
      color: #c05621;
    }

    .badge-contestada {
      background: #c6f6d5;
      color: #2f855a;
    }

    .badge-urgente {
      background: #f093fb;
      color: white;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .usuarios-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
    }

    .usuario-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .usuario-checkbox:hover {
      background: #f7fafc;
    }

    .usuario-checkbox input {
      cursor: pointer;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    select.form-control {
      width: auto;
      min-width: 150px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #718096;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const SUPABASE_URL = 'https://dhpwdkysrjjsagtiqwmz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRocHdka3lzcmpqc2FndGlxd216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MDcwMTMsImV4cCI6MjA4NjQ4MzAxM30.L4j6986BRq7ghpleZFh3GJqt5MfaMsRBwTDP3Ubhm90';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Componente de Login
    function Login({ onLogin }) {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        try {
          const { data: usuarioData, error: userError } = await supabase
            .from('usuarios')
            .select('email, activo')
            .eq('username', username)
            .single();

          if (userError || !usuarioData) {
            throw new Error('Usuario no encontrado');
          }

          if (!usuarioData.activo) {
            throw new Error('Usuario inactivo');
          }

          const { data, error } = await supabase.auth.signInWithPassword({
            email: usuarioData.email,
            password: password
          });

          if (error) throw error;

        } catch (err) {
          setError(err.message);
          setLoading(false);
        }
      };

      return (
        <div className="login-container">
          <div className="login-card">
            <h1 className="login-title">üî¨ Sistema de Pericias</h1>
            {error && <div className="alert alert-error">{error}</div>}
            <form onSubmit={handleSubmit}>
              <div className="form-group">
                <label className="form-label">Usuario</label>
                <input
                  type="text"
                  className="form-control"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  required
                  disabled={loading}
                />
              </div>
              <div className="form-group">
                <label className="form-label">Contrase√±a</label>
                <input
                  type="password"
                  className="form-control"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  disabled={loading}
                />
              </div>
              <button type="submit" className="btn btn-primary" style={{width: '100%'}} disabled={loading}>
                {loading ? 'Iniciando sesi√≥n...' : 'Ingresar'}
              </button>
            </form>
          </div>
        </div>
      );
    }

    // Componente Principal
    function App() {
      const [user, setUser] = useState(null);
      const [usuarioActual, setUsuarioActual] = useState(null);
      const [loading, setLoading] = useState(true);
      const [vistaActual, setVistaActual] = useState('pendientes');
      const [pericias, setPericias] = useState([]);
      const [usuarios, setUsuarios] = useState([]);
      const [auditLog, setAuditLog] = useState([]);
      const [filtroTurno, setFiltroTurno] = useState('todos');

      useEffect(() => {
        console.log('üîµ 1. Inicializando app...');
        
        // Intentar cargar usuario desde cach√©
        const cachedUser = localStorage.getItem('usuarioActual');
        if (cachedUser) {
          try {
            const parsed = JSON.parse(cachedUser);
            console.log('üì¶ Usuario cargado desde cach√©:', parsed.username);
            setUsuarioActual(parsed);
          } catch (e) {
            console.log('‚ö†Ô∏è Error al parsear cach√©, limpiando...');
            localStorage.removeItem('usuarioActual');
          }
        }

        const init = async () => {
          try {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session?.user) {
              console.log('‚úÖ Sesi√≥n activa encontrada');
              setUser(session.user);
              
              const { data: userData } = await supabase
                .from('usuarios')
                .select('*')
                .eq('id', session.user.id)
                .maybeSingle();
              
              if (userData) {
                console.log('‚úÖ Usuario cargado:', userData.username, userData.rol);
                setUsuarioActual(userData);
                localStorage.setItem('usuarioActual', JSON.stringify(userData));
              }
            }
          } catch (error) {
            console.error('‚ùå Error al inicializar:', error);
          } finally {
            setLoading(false);
          }
        };

        init();

        const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
          console.log('üîµ AUTH EVENT:', event);
          
          if (event === 'SIGNED_IN' && session?.user) {
            setUser(session.user);
            
            const { data: userData } = await supabase
              .from('usuarios')
              .select('*')
              .eq('id', session.user.id)
              .maybeSingle();
            
            if (userData) {
              setUsuarioActual(userData);
              localStorage.setItem('usuarioActual', JSON.stringify(userData));
            }
          } else if (event === 'SIGNED_OUT') {
            setUser(null);
            setUsuarioActual(null);
            localStorage.removeItem('usuarioActual');
          }
        });

        return () => subscription?.unsubscribe();
      }, []);

      useEffect(() => {
        if (user && usuarioActual) {
          cargarDatos();
        }
      }, [user, usuarioActual, vistaActual, filtroTurno]);

      const cargarDatos = async () => {
        try {
          // Cargar pericias seg√∫n vista
          let query = supabase.from('pericias').select(`
            *,
            creador:usuarios!pericias_creado_por_fkey(nombre_completo),
            asignaciones(usuario_id),
            contestaciones(id, usuario_id)
          `);

          // Filtrar por estado
          if (vistaActual === 'pendientes') {
            query = query.in('estado', ['pendiente', 'en_proceso']);
          } else if (vistaActual === 'contestadas') {
            query = query.eq('estado', 'contestada');
          }

          // Filtrar por turno seg√∫n rol
          if (usuarioActual.rol === 'encargado' && usuarioActual.turno) {
            query = query.eq('turno', usuarioActual.turno);
          } else if (usuarioActual.rol === 'usuario') {
            // Usuarios solo ven las asignadas a ellos
            const { data: misAsignaciones } = await supabase
              .from('asignaciones')
              .select('pericia_id')
              .eq('usuario_id', user.id);
            
            const periciaIds = misAsignaciones?.map(a => a.pericia_id) || [];
            query = query.in('id', periciaIds.length > 0 ? periciaIds : ['00000000-0000-0000-0000-000000000000']);
          }

          // Filtro adicional de turno (para admin y supervisor)
          if (filtroTurno !== 'todos' && ['administrador', 'supervisor'].includes(usuarioActual.rol)) {
            query = query.eq('turno', filtroTurno);
          }

          const { data: periciasData } = await query.order('created_at', { ascending: false });
          setPericias(periciasData || []);

          // Cargar usuarios
          if (['administrador', 'supervisor', 'encargado'].includes(usuarioActual.rol)) {
            const { data: usuariosData } = await supabase
              .from('usuarios')
              .select('*')
              .eq('activo', true)
              .order('nombre_completo');
            setUsuarios(usuariosData || []);
          }

          // Cargar auditor√≠a (solo admin)
          if (usuarioActual.rol === 'administrador' && vistaActual === 'auditoria') {
            const { data: auditData } = await supabase
              .from('audit_log')
              .select('*, usuarios(nombre_completo)')
              .order('created_at', { ascending: false })
              .limit(100);
            setAuditLog(auditData || []);
          }

        } catch (error) {
          console.error('Error al cargar datos:', error);
        }
      };

      const handleLogout = async () => {
        await supabase.auth.signOut();
        localStorage.removeItem('usuarioActual');
        window.location.reload();
      };

      const handleBorrarPericia = async (periciaId) => {
        if (!confirm('¬øEst√° seguro de borrar esta pericia? Esta acci√≥n quedar√° registrada en la auditor√≠a.')) {
          return;
        }

        try {
          const { error } = await supabase
            .from('pericias')
            .delete()
            .eq('id', periciaId);

          if (error) throw error;

          alert('Pericia borrada exitosamente');
          cargarDatos();
        } catch (error) {
          alert('Error al borrar pericia: ' + error.message);
        }
      };

      if (loading) {
        return (
          <div className="loading">
            <div className="spinner"></div>
            Cargando sistema...
          </div>
        );
      }

      if (!user || !usuarioActual) {
        return <Login />;
      }

      const esAdmin = usuarioActual.rol === 'administrador';
      const esSupervisor = usuarioActual.rol === 'supervisor';
      const esEncargado = usuarioActual.rol === 'encargado';

      return (
        <div className="container">
          <div className="header">
            <h1>üî¨ Sistema de Pericias Forenses</h1>
            <div className="user-info">
              <div className={`user-badge ${usuarioActual.rol}`}>
                {usuarioActual.rol === 'administrador' && 'üëë'}
                {usuarioActual.rol === 'supervisor' && 'üëÅÔ∏è'}
                {usuarioActual.rol === 'encargado' && 'üéñÔ∏è'}
                {usuarioActual.rol === 'usuario' && 'üë§'}
                {' '}
                {usuarioActual.nombre_completo} - {usuarioActual.rol.charAt(0).toUpperCase() + usuarioActual.rol.slice(1)}
                {usuarioActual.turno && ` (${usuarioActual.turno})`}
              </div>
              <button className="btn btn-secondary" onClick={handleLogout}>
                üö™ Salir
              </button>
            </div>
          </div>

          <div className="tabs">
            <div
              className={`tab ${vistaActual === 'pendientes' ? 'active' : ''}`}
              onClick={() => setVistaActual('pendientes')}
            >
              üì• Pendientes
            </div>
            <div
              className={`tab ${vistaActual === 'contestadas' ? 'active' : ''}`}
              onClick={() => setVistaActual('contestadas')}
            >
              ‚úÖ Contestadas
            </div>
            <div
              className={`tab ${vistaActual === 'nueva' ? 'active' : ''}`}
              onClick={() => setVistaActual('nueva')}
            >
              ‚ûï Nueva Pericia
            </div>
            {(esAdmin || esSupervisor) && (
              <div
                className={`tab ${vistaActual === 'todas' ? 'active' : ''}`}
                onClick={() => setVistaActual('todas')}
              >
                üìä Todas las Pericias
              </div>
            )}
            {esAdmin && (
              <>
                <div
                  className={`tab ${vistaActual === 'usuarios' ? 'active' : ''}`}
                  onClick={() => setVistaActual('usuarios')}
                >
                  üë• Gesti√≥n de Usuarios
                </div>
                <div
                  className={`tab ${vistaActual === 'auditoria' ? 'active' : ''}`}
                  onClick={() => setVistaActual('auditoria')}
                >
                  üìã Auditor√≠a
                </div>
              </>
            )}
          </div>

          {(esAdmin || esSupervisor) && ['pendientes', 'contestadas', 'todas'].includes(vistaActual) && (
            <div className="filters">
              <select
                className="form-control"
                value={filtroTurno}
                onChange={(e) => setFiltroTurno(e.target.value)}
              >
                <option value="todos">Todos los turnos</option>
                <option value="1er Turno">1er Turno</option>
                <option value="2do Turno">2do Turno</option>
                <option value="3er Turno">3er Turno</option>
              </select>
            </div>
          )}

          {vistaActual === 'pendientes' && (
            <ListaPericias
              pericias={pericias}
              usuarioActual={usuarioActual}
              onRecargar={cargarDatos}
              onBorrar={esAdmin ? handleBorrarPericia : null}
            />
          )}

          {vistaActual === 'contestadas' && (
            <ListaPericias
              pericias={pericias}
              usuarioActual={usuarioActual}
              onRecargar={cargarDatos}
              onBorrar={esAdmin ? handleBorrarPericia : null}
            />
          )}

          {vistaActual === 'nueva' && (
            <FormularioPericia
              usuarios={usuarios}
              usuarioActual={usuarioActual}
              onSuccess={() => {
                cargarDatos();
                setVistaActual('pendientes');
              }}
            />
          )}

          {vistaActual === 'todas' && (
            <ListaPericias
              pericias={pericias}
              usuarioActual={usuarioActual}
              onRecargar={cargarDatos}
              onBorrar={esAdmin ? handleBorrarPericia : null}
            />
          )}

          {vistaActual === 'usuarios' && esAdmin && (
            <GestionUsuarios usuarios={usuarios} onRecargar={cargarDatos} />
          )}

          {vistaActual === 'auditoria' && esAdmin && (
            <Auditoria logs={auditLog} />
          )}
        </div>
      );
    }

    // Componente Lista de Pericias
    function ListaPericias({ pericias, usuarioActual, onRecargar, onBorrar }) {
      const [periciaSeleccionada, setPericiaSeleccionada] = useState(null);

      if (pericias.length === 0) {
        return (
          <div className="card">
            <div className="empty-state">
              <div className="empty-state-icon">üì≠</div>
              <h3>No hay pericias en esta categor√≠a</h3>
            </div>
          </div>
        );
      }

      return (
        <div className="card">
          <div className="table-container">
            <table>
              <thead>
                <tr>
                  <th>N¬∞ SGSP</th>
                  <th>Turno</th>
                  <th>Fecha</th>
                  <th>Pericia</th>
                  <th>Plazo</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {pericias.map(pericia => {
                  const diasRestantes = Math.ceil((new Date(pericia.plazo) - new Date()) / (1000 * 60 * 60 * 24));
                  const esUrgente = diasRestantes <= 2 && pericia.estado !== 'contestada';

                  return (
                    <tr key={pericia.id}>
                      <td><strong>{pericia.numero_sgsp}</strong></td>
                      <td><span className="badge">{pericia.turno}</span></td>
                      <td>{new Date(pericia.fecha).toLocaleDateString()}</td>
                      <td>{pericia.pericia_solicitada.substring(0, 50)}...</td>
                      <td>
                        {new Date(pericia.plazo).toLocaleDateString()}
                        {esUrgente && <span className="badge badge-urgente" style={{marginLeft: '8px'}}>üî• URGENTE</span>}
                      </td>
                      <td>
                        <span className={`badge badge-${pericia.estado}`}>
                          {pericia.estado.charAt(0).toUpperCase() + pericia.estado.slice(1).replace('_', ' ')}
                        </span>
                      </td>
                      <td>
                        <button
                          className="btn btn-primary"
                          style={{fontSize: '12px', padding: '6px 12px'}}
                          onClick={() => setPericiaSeleccionada(pericia)}
                        >
                          Ver Detalle
                        </button>
                        {onBorrar && (
                          <button
                            className="btn btn-danger"
                            style={{fontSize: '12px', padding: '6px 12px', marginLeft: '8px'}}
                            onClick={() => onBorrar(pericia.id)}
                          >
                            üóëÔ∏è Borrar
                          </button>
                        )}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          {periciaSeleccionada && (
            <DetallePericia
              pericia={periciaSeleccionada}
              usuarioActual={usuarioActual}
              onClose={() => {
                setPericiaSeleccionada(null);
                onRecargar();
              }}
            />
          )}
        </div>
      );
    }

    // Componente Formulario de Pericia
    function FormularioPericia({ usuarios, usuarioActual, onSuccess }) {
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [formData, setFormData] = useState({
        fecha: new Date().toISOString().split('T')[0],
        hora: new Date().toTimeString().slice(0,5),
        numero_sgsp: '',
        pericia_solicitada: '',
        fiscalia: '1er Turno',
        plazo: '',
        numero_novedad: '',
        turno: '1er Turno',
        usuarios_asignados: []
      });

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        if (formData.usuarios_asignados.length === 0) {
          setError('Debe asignar al menos un usuario');
          setLoading(false);
          return;
        }

        try {
          const { data: { user } } = await supabase.auth.getUser();

          const { data: pericia, error: periciaError } = await supabase
            .from('pericias')
            .insert({
              fecha: formData.fecha,
              hora: formData.hora,
              numero_sgsp: formData.numero_sgsp,
              pericia_solicitada: formData.pericia_solicitada,
              fiscalia: formData.fiscalia,
              plazo: formData.plazo,
              numero_novedad: formData.numero_novedad,
              turno: formData.turno,
              creado_por: user.id
            })
            .select()
            .single();

          if (periciaError) throw periciaError;

          const asignaciones = formData.usuarios_asignados.map(userId => ({
            pericia_id: pericia.id,
            usuario_id: userId
          }));

          const { error: asignacionError } = await supabase
            .from('asignaciones')
            .insert(asignaciones);

          if (asignacionError) throw asignacionError;

          alert('Pericia creada exitosamente');
          onSuccess();
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const toggleUsuario = (userId) => {
        setFormData(prev => ({
          ...prev,
          usuarios_asignados: prev.usuarios_asignados.includes(userId)
            ? prev.usuarios_asignados.filter(id => id !== userId)
            : [...prev.usuarios_asignados, userId]
        }));
      };

      return (
        <div className="card">
          <h2>‚ûï Nueva Solicitud de Pericia</h2>
          {error && <div className="alert alert-error">{error}</div>}

          <form onSubmit={handleSubmit}>
            <div className="form-row">
              <div className="form-group">
                <label className="form-label">Fecha</label>
                <input
                  type="date"
                  className="form-control"
                  value={formData.fecha}
                  onChange={(e) => setFormData({...formData, fecha: e.target.value})}
                  required
                />
              </div>
              <div className="form-group">
                <label className="form-label">Hora</label>
                <input
                  type="time"
                  className="form-control"
                  value={formData.hora}
                  onChange={(e) => setFormData({...formData, hora: e.target.value})}
                  required
                />
              </div>
              <div className="form-group">
                <label className="form-label">N√∫mero SGSP</label>
                <input
                  type="text"
                  className="form-control"
                  value={formData.numero_sgsp}
                  onChange={(e) => setFormData({...formData, numero_sgsp: e.target.value})}
                  required
                />
              </div>
            </div>

            <div className="form-row">
              <div className="form-group">
                <label className="form-label">Turno</label>
                <select
                  className="form-control"
                  value={formData.turno}
                  onChange={(e) => setFormData({...formData, turno: e.target.value})}
                  required
                >
                  <option value="1er Turno">1er Turno</option>
                  <option value="2do Turno">2do Turno</option>
                  <option value="3er Turno">3er Turno</option>
                </select>
              </div>
              <div className="form-group">
                <label className="form-label">Fiscal√≠a</label>
                <input
                  type="text"
                  className="form-control"
                  value={formData.fiscalia}
                  onChange={(e) => setFormData({...formData, fiscalia: e.target.value})}
                  required
                />
              </div>
              <div className="form-group">
                <label className="form-label">Plazo</label>
                <input
                  type="date"
                  className="form-control"
                  value={formData.plazo}
                  onChange={(e) => setFormData({...formData, plazo: e.target.value})}
                  required
                />
              </div>
            </div>

            <div className="form-group">
              <label className="form-label">Pericia Solicitada</label>
              <textarea
                className="form-control"
                rows="4"
                value={formData.pericia_solicitada}
                onChange={(e) => setFormData({...formData, pericia_solicitada: e.target.value})}
                required
              />
            </div>

            <div className="form-group">
              <label className="form-label">N√∫mero de Novedad</label>
              <input
                type="text"
                className="form-control"
                value={formData.numero_novedad}
                onChange={(e) => setFormData({...formData, numero_novedad: e.target.value})}
              />
            </div>

            <div className="form-group">
              <label className="form-label">Asignar a Usuarios ({formData.usuarios_asignados.length} seleccionados)</label>
              <div className="usuarios-list">
                {usuarios.map(usuario => (
                  <label key={usuario.id} className="usuario-checkbox">
                    <input
                      type="checkbox"
                      checked={formData.usuarios_asignados.includes(usuario.id)}
                      onChange={() => toggleUsuario(usuario.id)}
                    />
                    {usuario.nombre_completo}
                    {usuario.turno && ` (${usuario.turno})`}
                  </label>
                ))}
              </div>
            </div>

            <button type="submit" className="btn btn-primary" disabled={loading}>
              {loading ? 'Guardando...' : '‚úÖ Crear Pericia'}
            </button>
          </form>
        </div>
      );
    }

    // Componente Detalle de Pericia (simplificado - no incluyo el c√≥digo completo por espacio)
    function DetallePericia({ pericia, usuarioActual, onClose }) {
      return (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '20px',
          zIndex: 1000
        }}>
          <div className="card" style={{maxWidth: '800px', maxHeight: '90vh', overflow: 'auto'}}>
            <h2>üìã Detalle de Pericia #{pericia.numero_sgsp}</h2>
            <p><strong>Turno:</strong> {pericia.turno}</p>
            <p><strong>Fecha:</strong> {new Date(pericia.fecha).toLocaleDateString()}</p>
            <p><strong>Plazo:</strong> {new Date(pericia.plazo).toLocaleDateString()}</p>
            <p><strong>Descripci√≥n:</strong> {pericia.pericia_solicitada}</p>
            <button className="btn btn-secondary" onClick={onClose}>Cerrar</button>
          </div>
        </div>
      );
    }

    // Componente Gesti√≥n de Usuarios
    function GestionUsuarios({ usuarios, onRecargar }) {
      return (
        <div className="card">
          <h2>üë• Gesti√≥n de Usuarios</h2>
          <div className="table-container">
            <table>
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Nombre</th>
                  <th>Rol</th>
                  <th>Turno</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody>
                {usuarios.map(usuario => (
                  <tr key={usuario.id}>
                    <td>{usuario.username}</td>
                    <td>{usuario.nombre_completo}</td>
                    <td>
                      <span className={`user-badge ${usuario.rol}`}>
                        {usuario.rol}
                      </span>
                    </td>
                    <td>{usuario.turno || 'Todos'}</td>
                    <td>
                      <span className={`badge ${usuario.activo ? 'badge-contestada' : 'badge-pendiente'}`}>
                        {usuario.activo ? 'Activo' : 'Inactivo'}
                      </span>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    // Componente Auditor√≠a
    function Auditoria({ logs }) {
      return (
        <div className="card">
          <h2>üìã Registro de Auditor√≠a</h2>
          <div className="table-container">
            <table>
              <thead>
                <tr>
                  <th>Fecha/Hora</th>
                  <th>Usuario</th>
                  <th>Operaci√≥n</th>
                  <th>Tabla</th>
                  <th>Detalles</th>
                </tr>
              </thead>
              <tbody>
                {logs.map(log => (
                  <tr key={log.id}>
                    <td>{new Date(log.created_at).toLocaleString()}</td>
                    <td>{log.usuarios?.nombre_completo || 'Sistema'}</td>
                    <td>
                      <span className={`badge ${log.operacion === 'DELETE' ? 'badge-pendiente' : 'badge-contestada'}`}>
                        {log.operacion}
                      </span>
                    </td>
                    <td>{log.tabla}</td>
                    <td style={{fontSize: '12px', maxWidth: '300px', overflow: 'hidden', textOverflow: 'ellipsis'}}>
                      {JSON.stringify(log.datos_nuevos || log.datos_anteriores || {}).substring(0, 100)}...
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
