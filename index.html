<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Pericias Forenses</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { color: #2d3748; font-size: 24px; font-weight: 700; }
    .user-info { display: flex; align-items: center; gap: 20px; }
    .user-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
    }
    .user-badge.administrador { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .user-badge.supervisor { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .user-badge.encargado { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-danger { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
    .btn-warning { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; }
    .btn-secondary { background: #e2e8f0; color: #4a5568; }
    .btn-success { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab {
      background: white;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 400px;
      color: white;
      font-size: 18px;
    }
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .login-container { max-width: 400px; margin: 100px auto; }
    .login-card {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .login-title { font-size: 28px; font-weight: 700; text-align: center; color: #2d3748; margin-bottom: 30px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; }
    .form-control {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    .form-control:focus { outline: none; border-color: #667eea; }
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    .alert-error { background: #fed7d7; color: #c53030; border-left: 4px solid #f56565; }
    .alert-success { background: #c6f6d5; color: #2f855a; border-left: 4px solid #48bb78; }
    .alert-warning { background: #feebc8; color: #c05621; border-left: 4px solid #f6ad55; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th {
      background: #f7fafc;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #4a5568;
      border-bottom: 2px solid #e2e8f0;
    }
    td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
    tr:hover { background: #f7fafc; cursor: pointer; }
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-pendiente { background: #fed7d7; color: #c53030; }
    .badge-en-proceso { background: #feebc8; color: #c05621; }
    .badge-contestada { background: #c6f6d5; color: #2f855a; }
    .badge-urgente { background: #f093fb; color: white; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .usuarios-selector {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      background: #f7fafc;
    }
    .usuarios-search { margin-bottom: 15px; }
    .usuarios-search input {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #cbd5e0;
      border-radius: 8px;
      font-size: 14px;
    }
    .usuarios-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: white;
      border-radius: 8px;
      margin-bottom: 15px;
      font-weight: 600;
      color: #4a5568;
    }
    .usuarios-por-turno { display: grid; gap: 15px; }
    .turno-group {
      background: white;
      border-radius: 10px;
      padding: 15px;
      border: 2px solid #e2e8f0;
    }
    .turno-header {
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .usuarios-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }
    .usuario-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      background: #f7fafc;
      border: 1px solid #e2e8f0;
    }
    .usuario-checkbox:hover { background: #edf2f7; border-color: #cbd5e0; }
    .usuario-checkbox.selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }
    .select-all-turno {
      font-size: 12px;
      padding: 4px 8px;
      background: transparent;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .select-all-turno:hover { background: #edf2f7; }
    .filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    select.form-control { width: auto; min-width: 150px; }
    .empty-state { text-align: center; padding: 60px 20px; color: #718096; }
    .empty-state-icon { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 15px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 30px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e2e8f0;
    }
    .modal-header h3 { font-size: 20px; color: #2d3748; }
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #718096;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    .close-btn:hover { background: #edf2f7; color: #2d3748; }
    .char-counter {
      text-align: right;
      font-size: 12px;
      color: #718096;
      margin-top: 5px;
    }
    .char-counter.error { color: #c53030; font-weight: 600; }
    .detalle-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e2e8f0;
    }
    .detalle-section:last-child { border-bottom: none; }
    .detalle-label {
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 5px;
    }
    .detalle-value { color: #2d3748; }
    .usuarios-asignados-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .usuario-asignado-item {
      padding: 8px 12px;
      background: #f7fafc;
      border-radius: 6px;
      font-size: 14px;
    }
    .btn-group {
      display: flex;
      gap: 8px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const SUPABASE_URL = 'https://dhpwdkysrjjsagtiqwmz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRocHdka3lzcmpqc2FndGlxd216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MDcwMTMsImV4cCI6MjA4NjQ4MzAxM30.L4j6986BRq7ghpleZFh3GJqt5MfaMsRBwTDP3Ubhm90';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const FISCALIAS = [
      '1er Turno',
      '2do Turno',
      '3er Turno',
      '4to Turno',
      '5to Turno',
      '1er Turno Delitos Sexuales',
      '2do Turno Delitos Sexuales'
    ];

    // Login Component
    function Login() {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        try {
          const { data: usuarioData, error: userError } = await supabase
            .from('usuarios')
            .select('email, activo')
            .eq('username', username)
            .single();

          if (userError || !usuarioData) throw new Error('Usuario no encontrado');
          if (!usuarioData.activo) throw new Error('Usuario inactivo');

          const { error } = await supabase.auth.signInWithPassword({
            email: usuarioData.email,
            password: password
          });

          if (error) throw error;
        } catch (err) {
          setError(err.message);
          setLoading(false);
        }
      };

      return (
        <div className="login-container">
          <div className="login-card">
            <h1 className="login-title">üî¨ Sistema de Pericias</h1>
            {error && <div className="alert alert-error">{error}</div>}
            <form onSubmit={handleSubmit}>
              <div className="form-group">
                <label className="form-label">Usuario</label>
                <input
                  type="text"
                  className="form-control"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  required
                  disabled={loading}
                />
              </div>
              <div className="form-group">
                <label className="form-label">Contrase√±a</label>
                <input
                  type="password"
                  className="form-control"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  disabled={loading}
                />
              </div>
              <button type="submit" className="btn btn-primary" style={{width: '100%'}} disabled={loading}>
                {loading ? 'Iniciando sesi√≥n...' : 'Ingresar'}
              </button>
            </form>
          </div>
        </div>
      );
    }

    // Selector Usuarios Component
    function SelectorUsuarios({ usuarios, usuariosSeleccionados, onChange }) {
      const [busqueda, setBusqueda] = useState('');

      const usuariosFiltrados = useMemo(() => {
        if (!busqueda) return usuarios;
        return usuarios.filter(u => 
          u.nombre_completo.toLowerCase().includes(busqueda.toLowerCase()) ||
          u.username.toLowerCase().includes(busqueda.toLowerCase())
        );
      }, [usuarios, busqueda]);

      const usuariosPorTurno = useMemo(() => {
        const grupos = {
          '1er Turno': [],
          '2do Turno': [],
          '3er Turno': [],
          'Sin Turno': []
        };

        usuariosFiltrados.forEach(usuario => {
          const turno = usuario.turno || 'Sin Turno';
          if (grupos[turno]) {
            grupos[turno].push(usuario);
          }
        });

        return grupos;
      }, [usuariosFiltrados]);

      const toggleUsuario = (userId) => {
        const nuevosSeleccionados = usuariosSeleccionados.includes(userId)
          ? usuariosSeleccionados.filter(id => id !== userId)
          : [...usuariosSeleccionados, userId];
        onChange(nuevosSeleccionados);
      };

      const seleccionarTodosTurno = (turno) => {
        const usuariosTurno = usuariosPorTurno[turno].map(u => u.id);
        const todosSeleccionados = usuariosTurno.every(id => usuariosSeleccionados.includes(id));
        
        if (todosSeleccionados) {
          onChange(usuariosSeleccionados.filter(id => !usuariosTurno.includes(id)));
        } else {
          const nuevos = [...new Set([...usuariosSeleccionados, ...usuariosTurno])];
          onChange(nuevos);
        }
      };

      return (
        <div className="usuarios-selector">
          <div className="usuarios-search">
            <input
              type="text"
              placeholder="üîç Buscar usuario..."
              value={busqueda}
              onChange={(e) => setBusqueda(e.target.value)}
            />
          </div>
          <div className="usuarios-stats">
            <span>üë• {usuariosSeleccionados.length} seleccionado(s)</span>
            <button type="button" className="btn btn-secondary" style={{fontSize: '12px', padding: '6px 12px'}} onClick={() => onChange([])}>
              Limpiar
            </button>
          </div>
          <div className="usuarios-por-turno">
            {Object.entries(usuariosPorTurno).map(([turno, usuariosTurno]) => {
              if (usuariosTurno.length === 0) return null;
              const todosSeleccionados = usuariosTurno.every(u => usuariosSeleccionados.includes(u.id));
              return (
                <div key={turno} className="turno-group">
                  <div className="turno-header">
                    <span>{turno}</span>
                    <div style={{display: 'flex', gap: '8px', alignItems: 'center'}}>
                      <span className="badge">{usuariosTurno.filter(u => usuariosSeleccionados.includes(u.id)).length}/{usuariosTurno.length}</span>
                      <button type="button" className="select-all-turno" onClick={() => seleccionarTodosTurno(turno)}>
                        {todosSeleccionados ? '‚úì Todos' : 'Seleccionar'}
                      </button>
                    </div>
                  </div>
                  <div className="usuarios-grid">
                    {usuariosTurno.map(usuario => (
                      <label key={usuario.id} className={`usuario-checkbox ${usuariosSeleccionados.includes(usuario.id) ? 'selected' : ''}`}>
                        <input
                          type="checkbox"
                          checked={usuariosSeleccionados.includes(usuario.id)}
                          onChange={() => toggleUsuario(usuario.id)}
                          style={{display: 'none'}}
                        />
                        <span style={{fontSize: '12px'}}>{usuario.nombre_completo}</span>
                      </label>
                    ))}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    // Modal Detalle Pericia
    function ModalDetallePericia({ pericia, onClose }) {
      const [usuariosAsignados, setUsuariosAsignados] = useState([]);
      const [contestaciones, setContestaciones] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const cargarDetalle = async () => {
          try {
            const { data: asignacionesData } = await supabase
              .from('asignaciones')
              .select('usuario_id, usuarios(nombre_completo, turno)')
              .eq('pericia_id', pericia.id);

            const { data: contestacionesData } = await supabase
              .from('contestaciones')
              .select('*, usuarios(nombre_completo)')
              .eq('pericia_id', pericia.id)
              .order('created_at', { ascending: false });

            setUsuariosAsignados(asignacionesData || []);
            setContestaciones(contestacionesData || []);
          } catch (error) {
            console.error('Error:', error);
          } finally {
            setLoading(false);
          }
        };

        cargarDetalle();
      }, [pericia.id]);

      const diasRestantes = Math.ceil((new Date(pericia.plazo) - new Date()) / (1000 * 60 * 60 * 24));

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h3>üìã Pericia #{pericia.numero_sgsp}</h3>
              <button className="close-btn" onClick={onClose}>√ó</button>
            </div>

            {loading ? (
              <div style={{textAlign: 'center', padding: '20px'}}>Cargando...</div>
            ) : (
              <>
                <div className="detalle-section">
                  <div className="detalle-label">Informaci√≥n General</div>
                  <p><strong>Turno:</strong> {pericia.turno}</p>
                  <p><strong>Fiscal√≠a:</strong> {pericia.fiscalia}</p>
                  <p><strong>Fecha:</strong> {new Date(pericia.fecha).toLocaleDateString()} {pericia.hora}</p>
                  <p><strong>Plazo:</strong> {new Date(pericia.plazo).toLocaleDateString()} <span style={{color: diasRestantes <= 2 ? '#c53030' : '#2d3748'}}>({diasRestantes} d√≠as {diasRestantes <= 2 ? 'üî•' : ''})</span></p>
                  <p><strong>Estado:</strong> <span className={`badge badge-${pericia.estado}`}>{pericia.estado}</span></p>
                </div>

                <div className="detalle-section">
                  <div className="detalle-label">Pericia Solicitada</div>
                  <div className="detalle-value" style={{whiteSpace: 'pre-wrap'}}>{pericia.pericia_solicitada}</div>
                </div>

                {pericia.numero_novedad && (
                  <div className="detalle-section">
                    <div className="detalle-label">N√∫mero de Novedad</div>
                    <div className="detalle-value">{pericia.numero_novedad}</div>
                  </div>
                )}

                <div className="detalle-section">
                  <div className="detalle-label">Usuarios Asignados ({usuariosAsignados.length})</div>
                  <div className="usuarios-asignados-list">
                    {usuariosAsignados.map((asig, idx) => (
                      <div key={idx} className="usuario-asignado-item">
                        üë§ {asig.usuarios?.nombre_completo}
                        {asig.usuarios?.turno && <div style={{fontSize: '11px', color: '#718096'}}>{asig.usuarios.turno}</div>}
                      </div>
                    ))}
                  </div>
                </div>

                <div className="detalle-section">
                  <div className="detalle-label">Contestaciones ({contestaciones.length}/{usuariosAsignados.length})</div>
                  {contestaciones.length > 0 ? (
                    contestaciones.map((cont, idx) => (
                      <div key={idx} style={{marginBottom: '10px', padding: '10px', background: '#f7fafc', borderRadius: '6px'}}>
                        <div style={{fontSize: '12px', color: '#718096', marginBottom: '5px'}}>
                          {cont.usuarios?.nombre_completo} - {new Date(cont.created_at).toLocaleString()}
                        </div>
                        <div style={{fontSize: '14px'}}>{cont.contestacion.substring(0, 150)}...</div>
                      </div>
                    ))
                  ) : (
                    <div style={{color: '#718096', fontStyle: 'italic'}}>Sin contestaciones a√∫n</div>
                  )}
                </div>
              </>
            )}
          </div>
        </div>
      );
    }

    // Main App Component
    function App() {
      const [user, setUser] = useState(null);
      const [usuarioActual, setUsuarioActual] = useState(null);
      const [loading, setLoading] = useState(true);
      const [vistaActual, setVistaActual] = useState('pendientes');
      const [pericias, setPericias] = useState([]);
      const [usuarios, setUsuarios] = useState([]);
      const [filtroTurno, setFiltroTurno] = useState('todos');
      const [periciaDetalle, setPericiaDetalle] = useState(null);

      useEffect(() => {
        const cachedUser = localStorage.getItem('usuarioActual');
        if (cachedUser) {
          try {
            setUsuarioActual(JSON.parse(cachedUser));
          } catch (e) {
            localStorage.removeItem('usuarioActual');
          }
        }

        const init = async () => {
          try {
            // Timeout de 10 segundos para detectar si se queda atascado
            const timeoutId = setTimeout(() => {
              console.error('Timeout detectado - limpiando localStorage');
              localStorage.clear();
              window.location.reload();
            }, 10000);

            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            
            clearTimeout(timeoutId);

            if (sessionError) {
              console.error('Error de sesi√≥n:', sessionError);
              localStorage.clear();
              setLoading(false);
              return;
            }
            
            if (session?.user) {
              setUser(session.user);
              
              const { data: userData, error: userError } = await supabase
                .from('usuarios')
                .select('*')
                .eq('id', session.user.id)
                .maybeSingle();
              
              if (userError) {
                console.error('Error al cargar usuario:', userError);
                localStorage.clear();
                await supabase.auth.signOut();
                setLoading(false);
                return;
              }

              if (userData) {
                setUsuarioActual(userData);
                localStorage.setItem('usuarioActual', JSON.stringify(userData));
              }
            }
          } catch (error) {
            console.error('Error en init:', error);
            localStorage.clear();
          } finally {
            setLoading(false);
          }
        };

        init();

        const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
          if (event === 'SIGNED_IN' && session?.user) {
            setUser(session.user);
            const { data: userData } = await supabase.from('usuarios').select('*').eq('id', session.user.id).maybeSingle();
            if (userData) {
              setUsuarioActual(userData);
              localStorage.setItem('usuarioActual', JSON.stringify(userData));
            }
          } else if (event === 'SIGNED_OUT') {
            setUser(null);
            setUsuarioActual(null);
            localStorage.clear();
          }
        });

        return () => subscription?.unsubscribe();
      }, []);

      useEffect(() => {
        if (user && usuarioActual) {
          cargarDatos();
        }
      }, [user, usuarioActual, vistaActual, filtroTurno]);

      const cargarDatos = async () => {
        try {
          let query = supabase.from('pericias').select('*');

          if (vistaActual !== 'archivadas') {
            query = query.is('deleted_at', null);
          } else {
            query = query.not('deleted_at', 'is', null);
          }

          if (vistaActual === 'pendientes') {
            query = query.in('estado', ['pendiente', 'en_proceso']);
          } else if (vistaActual === 'contestadas') {
            query = query.eq('estado', 'contestada');
          }

          if (usuarioActual.rol === 'encargado' && usuarioActual.turno) {
            query = query.eq('turno', usuarioActual.turno);
          } else if (usuarioActual.rol === 'usuario') {
            const { data: misAsignaciones } = await supabase
              .from('asignaciones')
              .select('pericia_id')
              .eq('usuario_id', user.id);
            
            const periciaIds = misAsignaciones?.map(a => a.pericia_id) || [];
            query = query.in('id', periciaIds.length > 0 ? periciaIds : ['00000000-0000-0000-0000-000000000000']);
          }

          if (filtroTurno !== 'todos' && ['administrador', 'supervisor'].includes(usuarioActual.rol)) {
            query = query.eq('turno', filtroTurno);
          }

          const { data: periciasData } = await query.order('created_at', { ascending: false });
          setPericias(periciasData || []);

          if (['administrador', 'supervisor', 'encargado'].includes(usuarioActual.rol)) {
            const { data: usuariosData } = await supabase
              .from('usuarios')
              .select('*')
              .eq('activo', true)
              .order('nombre_completo');
            setUsuarios(usuariosData || []);
          }
        } catch (error) {
          console.error('Error:', error);
        }
      };

      const handleLogout = async () => {
        await supabase.auth.signOut();
        localStorage.clear();
        window.location.reload();
      };

      const handleArchivarPericia = async (periciaId) => {
        const motivo = prompt('Motivo del archivo (ser√° registrado en auditor√≠a):');
        if (!motivo) return;

        try {
          const { data, error } = await supabase.rpc('soft_delete_pericia', {
            p_pericia_id: periciaId,
            p_motivo: motivo
          });

          if (error) throw error;
          if (data && !data.success) throw new Error(data.error);

          alert('Pericia archivada correctamente');
          cargarDatos();
        } catch (error) {
          alert('Error: ' + error.message);
        }
      };

      const handleEliminarFisico = async (periciaId, numeroSgsp) => {
        if (!confirm(`‚ö†Ô∏è ADVERTENCIA ‚ö†Ô∏è\n\nEst√°s a punto de ELIMINAR PERMANENTEMENTE la pericia #${numeroSgsp}.\n\nEsta acci√≥n NO SE PUEDE DESHACER y NO quedar√° en auditor√≠a.\n\nSolo deber√≠as hacer esto si es una PRUEBA.\n\n¬øEst√°s COMPLETAMENTE SEGURO?`)) {
          return;
        }

        const confirmacion = prompt('Para confirmar, escribe: ELIMINAR');
        if (confirmacion !== 'ELIMINAR') {
          alert('Eliminaci√≥n cancelada');
          return;
        }

        try {
          // Primero eliminar asignaciones y contestaciones
          await supabase.from('asignaciones').delete().eq('pericia_id', periciaId);
          await supabase.from('contestaciones').delete().eq('pericia_id', periciaId);

          // Luego eliminar la pericia
          const { error } = await supabase
            .from('pericias')
            .delete()
            .eq('id', periciaId);

          if (error) throw error;

          alert('Pericia eliminada permanentemente');
          cargarDatos();
        } catch (error) {
          alert('Error: ' + error.message);
        }
      };

      const handleRestaurarPericia = async (periciaId) => {
        if (!confirm('¬øRestaurar esta pericia?')) return;

        try {
          const { data, error } = await supabase.rpc('restore_pericia', {
            p_pericia_id: periciaId
          });

          if (error) throw error;
          if (data && !data.success) throw new Error(data.error);

          alert('Pericia restaurada');
          cargarDatos();
        } catch (error) {
          alert('Error: ' + error.message);
        }
      };

      if (loading) {
        return (
          <div className="loading">
            <div className="spinner"></div>
            Cargando...
          </div>
        );
      }

      if (!user || !usuarioActual) return <Login />;

      const esAdmin = usuarioActual.rol === 'administrador';
      const esSupervisor = usuarioActual.rol === 'supervisor';

      return (
        <div className="container">
          <div className="header">
            <h1>üî¨ Sistema de Pericias Forenses</h1>
            <div className="user-info">
              <div className={`user-badge ${usuarioActual.rol}`}>
                {usuarioActual.rol === 'administrador' && 'üëë'}
                {usuarioActual.rol === 'supervisor' && 'üëÅÔ∏è'}
                {usuarioActual.rol === 'encargado' && 'üéñÔ∏è'}
                {usuarioActual.rol === 'usuario' && 'üë§'}
                {' '}{usuarioActual.nombre_completo} - {usuarioActual.rol.charAt(0).toUpperCase() + usuarioActual.rol.slice(1)}
                {usuarioActual.turno && ` (${usuarioActual.turno})`}
              </div>
              <button className="btn btn-secondary" onClick={handleLogout}>üö™ Salir</button>
            </div>
          </div>

          <div className="tabs">
            <div className={`tab ${vistaActual === 'pendientes' ? 'active' : ''}`} onClick={() => setVistaActual('pendientes')}>üì• Pendientes</div>
            <div className={`tab ${vistaActual === 'contestadas' ? 'active' : ''}`} onClick={() => setVistaActual('contestadas')}>‚úÖ Contestadas</div>
            <div className={`tab ${vistaActual === 'nueva' ? 'active' : ''}`} onClick={() => setVistaActual('nueva')}>‚ûï Nueva</div>
            {(esAdmin || esSupervisor) && <div className={`tab ${vistaActual === 'todas' ? 'active' : ''}`} onClick={() => setVistaActual('todas')}>üìä Todas</div>}
            {esAdmin && <div className={`tab ${vistaActual === 'archivadas' ? 'active' : ''}`} onClick={() => setVistaActual('archivadas')}>üóëÔ∏è Archivadas</div>}
            {esAdmin && <div className={`tab ${vistaActual === 'usuarios' ? 'active' : ''}`} onClick={() => setVistaActual('usuarios')}>üë• Usuarios</div>}
          </div>

          {(esAdmin || esSupervisor) && ['pendientes', 'contestadas', 'todas', 'archivadas'].includes(vistaActual) && (
            <div className="filters">
              <select className="form-control" value={filtroTurno} onChange={(e) => setFiltroTurno(e.target.value)}>
                <option value="todos">Todos los turnos</option>
                <option value="1er Turno">1er Turno</option>
                <option value="2do Turno">2do Turno</option>
                <option value="3er Turno">3er Turno</option>
              </select>
            </div>
          )}

          {['pendientes', 'contestadas', 'todas', 'archivadas'].includes(vistaActual) && (
            <ListaPericias
              pericias={pericias}
              esArchivadas={vistaActual === 'archivadas'}
              esAdmin={esAdmin}
              onVerDetalle={(p) => setPericiaDetalle(p)}
              onArchivar={esAdmin && vistaActual !== 'archivadas' ? handleArchivarPericia : null}
              onEliminar={esAdmin && vistaActual !== 'archivadas' ? handleEliminarFisico : null}
              onRestaurar={esAdmin && vistaActual === 'archivadas' ? handleRestaurarPericia : null}
            />
          )}

          {vistaActual === 'nueva' && (
            <FormularioPericia
              usuarios={usuarios}
              onSuccess={() => {
                cargarDatos();
                setVistaActual('pendientes');
              }}
            />
          )}

          {vistaActual === 'usuarios' && esAdmin && (
            <GestionUsuarios usuarios={usuarios} onRecargar={cargarDatos} />
          )}

          {periciaDetalle && (
            <ModalDetallePericia
              pericia={periciaDetalle}
              onClose={() => setPericiaDetalle(null)}
            />
          )}
        </div>
      );
    }

    // Lista Pericias Component
    function ListaPericias({ pericias, esArchivadas, esAdmin, onVerDetalle, onArchivar, onEliminar, onRestaurar }) {
      if (pericias.length === 0) {
        return (
          <div className="card">
            <div className="empty-state">
              <div className="empty-state-icon">üì≠</div>
              <h3>No hay pericias</h3>
            </div>
          </div>
        );
      }

      return (
        <div className="card">
          <div className="table-container">
            <table>
              <thead>
                <tr>
                  <th>N¬∞ SGSP</th>
                  <th>Turno</th>
                  <th>Fecha</th>
                  <th>Pericia</th>
                  <th>Plazo</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {pericias.map(pericia => {
                  const diasRestantes = Math.ceil((new Date(pericia.plazo) - new Date()) / (1000 * 60 * 60 * 24));
                  const esUrgente = diasRestantes <= 2 && pericia.estado !== 'contestada';

                  return (
                    <tr key={pericia.id} onClick={() => onVerDetalle(pericia)}>
                      <td><strong>{pericia.numero_sgsp}</strong></td>
                      <td><span className="badge">{pericia.turno}</span></td>
                      <td>{new Date(pericia.fecha).toLocaleDateString()}</td>
                      <td>{pericia.pericia_solicitada.substring(0, 50)}...</td>
                      <td>
                        {new Date(pericia.plazo).toLocaleDateString()}
                        {esUrgente && <span className="badge badge-urgente" style={{marginLeft: '8px'}}>üî•</span>}
                      </td>
                      <td>
                        <span className={`badge badge-${pericia.estado}`}>
                          {pericia.estado.charAt(0).toUpperCase() + pericia.estado.slice(1).replace('_', ' ')}
                        </span>
                      </td>
                      <td onClick={(e) => e.stopPropagation()}>
                        <div className="btn-group">
                          {onArchivar && (
                            <button className="btn btn-secondary" style={{fontSize: '12px', padding: '6px 12px'}} onClick={() => onArchivar(pericia.id)}>
                              üì¶ Archivar
                            </button>
                          )}
                          {onEliminar && (
                            <button className="btn btn-danger" style={{fontSize: '12px', padding: '6px 12px'}} onClick={() => onEliminar(pericia.id, pericia.numero_sgsp)}>
                              ‚ö†Ô∏è Eliminar
                            </button>
                          )}
                          {onRestaurar && (
                            <button className="btn btn-success" style={{fontSize: '12px', padding: '6px 12px'}} onClick={() => onRestaurar(pericia.id)}>
                              ‚Ü©Ô∏è Restaurar
                            </button>
                          )}
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    // Formulario Pericia Component  
    function FormularioPericia({ usuarios, onSuccess }) {
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [formData, setFormData] = useState({
        fecha: new Date().toISOString().split('T')[0],
        hora: new Date().toTimeString().slice(0,5),
        numero_sgsp: '',
        pericia_solicitada: '',
        fiscalia: '',
        plazo: '',
        numero_novedad: '',
        turno: '1er Turno',
        usuarios_asignados: []
      });

      const contadorChars = formData.pericia_solicitada.length;
      const esValido = contadorChars >= 20 && contadorChars <= 5000;

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        const descripcion = formData.pericia_solicitada.trim();
        
        if (descripcion.length < 20) {
          setError('La descripci√≥n debe tener al menos 20 caracteres');
          setLoading(false);
          return;
        }

        if (descripcion.length > 5000) {
          setError('La descripci√≥n no puede exceder 5000 caracteres');
          setLoading(false);
          return;
        }

        if (formData.usuarios_asignados.length === 0) {
          setError('Debe asignar al menos un usuario');
          setLoading(false);
          return;
        }

        if (!formData.fiscalia) {
          setError('Debe seleccionar una fiscal√≠a');
          setLoading(false);
          return;
        }

        try {
          const { data: { user } } = await supabase.auth.getUser();

          const { data: pericia, error: periciaError } = await supabase
            .from('pericias')
            .insert({
              fecha: formData.fecha,
              hora: formData.hora,
              numero_sgsp: formData.numero_sgsp,
              pericia_solicitada: descripcion,
              fiscalia: formData.fiscalia,
              plazo: formData.plazo,
              numero_novedad: formData.numero_novedad,
              turno: formData.turno,
              creado_por: user.id
            })
            .select()
            .single();

          if (periciaError) throw periciaError;

          const asignaciones = formData.usuarios_asignados.map(userId => ({
            pericia_id: pericia.id,
            usuario_id: userId
          }));

          const { error: asignacionError } = await supabase
            .from('asignaciones')
            .insert(asignaciones);

          if (asignacionError) throw asignacionError;

          alert('Pericia creada exitosamente');
          onSuccess();
        } catch (err) {
          setError('Error: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="card">
          <h2>‚ûï Nueva Solicitud de Pericia</h2>
          {error && <div className="alert alert-error">{error}</div>}

          <form onSubmit={handleSubmit}>
            <div className="form-row">
              <div className="form-group">
                <label className="form-label">Fecha</label>
                <input type="date" className="form-control" value={formData.fecha} onChange={(e) => setFormData({...formData, fecha: e.target.value})} required />
              </div>
              <div className="form-group">
                <label className="form-label">Hora</label>
                <input type="time" className="form-control" value={formData.hora} onChange={(e) => setFormData({...formData, hora: e.target.value})} required />
              </div>
              <div className="form-group">
                <label className="form-label">N√∫mero SGSP</label>
                <input type="text" className="form-control" value={formData.numero_sgsp} onChange={(e) => setFormData({...formData, numero_sgsp: e.target.value})} required />
              </div>
            </div>

            <div className="form-row">
              <div className="form-group">
                <label className="form-label">Turno</label>
                <select className="form-control" value={formData.turno} onChange={(e) => setFormData({...formData, turno: e.target.value})} required>
                  <option value="1er Turno">1er Turno</option>
                  <option value="2do Turno">2do Turno</option>
                  <option value="3er Turno">3er Turno</option>
                </select>
              </div>
              <div className="form-group">
                <label className="form-label">Fiscal√≠a</label>
                <select className="form-control" value={formData.fiscalia} onChange={(e) => setFormData({...formData, fiscalia: e.target.value})} required>
                  <option value="">Seleccionar...</option>
                  {FISCALIAS.map(f => <option key={f} value={f}>{f}</option>)}
                </select>
              </div>
              <div className="form-group">
                <label className="form-label">Plazo</label>
                <input type="date" className="form-control" value={formData.plazo} onChange={(e) => setFormData({...formData, plazo: e.target.value})} required />
              </div>
            </div>

            <div className="form-group">
              <label className="form-label">Pericia Solicitada</label>
              <textarea 
                className="form-control" 
                rows="4" 
                value={formData.pericia_solicitada} 
                onChange={(e) => setFormData({...formData, pericia_solicitada: e.target.value})} 
                required 
                minLength="20"
                maxLength="5000"
              />
              <div className={`char-counter ${!esValido && contadorChars > 0 ? 'error' : ''}`}>
                {contadorChars} / 5000 caracteres
                {contadorChars > 0 && contadorChars < 20 && <span> - ‚ö†Ô∏è M√≠nimo 20 caracteres</span>}
              </div>
            </div>

            <div className="form-group">
              <label className="form-label">N√∫mero de Novedad (opcional)</label>
              <input type="text" className="form-control" value={formData.numero_novedad} onChange={(e) => setFormData({...formData, numero_novedad: e.target.value})} />
            </div>

            <div className="form-group">
              <label className="form-label">Asignar Usuarios</label>
              <SelectorUsuarios
                usuarios={usuarios}
                usuariosSeleccionados={formData.usuarios_asignados}
                onChange={(seleccionados) => setFormData({...formData, usuarios_asignados: seleccionados})}
              />
            </div>

            <button type="submit" className="btn btn-primary" disabled={loading || !esValido}>
              {loading ? '‚è≥ Guardando...' : '‚úÖ Crear Pericia'}
            </button>
          </form>
        </div>
      );
    }

    // Modal Editar Usuario
    function ModalEditarUsuario({ usuario, onClose, onGuardar }) {
      const [rol, setRol] = useState(usuario.rol);
      const [turno, setTurno] = useState(usuario.turno || '');
      const [activo, setActivo] = useState(usuario.activo);
      const [nombreCompleto, setNombreCompleto] = useState(usuario.nombre_completo);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleGuardar = async () => {
        setLoading(true);
        setError('');

        try {
          const turnoFinal = ['administrador', 'supervisor'].includes(rol) ? null : turno || null;

          const { error: updateError } = await supabase
            .from('usuarios')
            .update({
              rol: rol,
              turno: turnoFinal,
              activo: activo,
              nombre_completo: nombreCompleto
            })
            .eq('id', usuario.id);

          if (updateError) throw updateError;
          onGuardar();
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const esAdminOSupervisor = ['administrador', 'supervisor'].includes(rol);

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h3>‚úèÔ∏è Editar Usuario</h3>
              <button className="close-btn" onClick={onClose}>√ó</button>
            </div>

            {error && <div className="alert alert-error">{error}</div>}

            <div className="form-group">
              <label className="form-label">Usuario</label>
              <input type="text" className="form-control" value={usuario.username} disabled />
            </div>

            <div className="form-group">
              <label className="form-label">Nombre Completo</label>
              <input 
                type="text" 
                className="form-control" 
                value={nombreCompleto} 
                onChange={(e) => setNombreCompleto(e.target.value)}
                required
              />
            </div>

            <div className="form-group">
              <label className="form-label">Rol</label>
              <select className="form-control" value={rol} onChange={(e) => setRol(e.target.value)}>
                <option value="administrador">üëë Administrador</option>
                <option value="supervisor">üëÅÔ∏è Supervisor</option>
                <option value="encargado">üéñÔ∏è Encargado</option>
                <option value="usuario">üë§ Usuario</option>
              </select>
            </div>

            {!esAdminOSupervisor && (
              <div className="form-group">
                <label className="form-label">Turno</label>
                <select className="form-control" value={turno} onChange={(e) => setTurno(e.target.value)}>
                  <option value="">Seleccionar...</option>
                  <option value="1er Turno">1er Turno</option>
                  <option value="2do Turno">2do Turno</option>
                  <option value="3er Turno">3er Turno</option>
                </select>
              </div>
            )}

            {esAdminOSupervisor && (
              <div className="alert" style={{background: '#bee3f8', color: '#2c5282', border: 'none'}}>
                ‚ÑπÔ∏è Administradores y Supervisores ven todos los turnos
              </div>
            )}

            <div className="form-group">
              <label style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                <input type="checkbox" checked={activo} onChange={(e) => setActivo(e.target.checked)} style={{width: 'auto'}} />
                <span className="form-label" style={{marginBottom: 0}}>Usuario Activo</span>
              </label>
            </div>

            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
              <button className="btn btn-success" onClick={handleGuardar} disabled={loading} style={{flex: 1}}>
                {loading ? 'Guardando...' : 'üíæ Guardar'}
              </button>
              <button className="btn btn-secondary" onClick={onClose} disabled={loading}>Cancelar</button>
            </div>
          </div>
        </div>
      );
    }

    // Gesti√≥n Usuarios Component
    function GestionUsuarios({ usuarios, onRecargar }) {
      const [usuarioEditar, setUsuarioEditar] = useState(null);

      return (
        <div className="card">
          <h2>üë• Gesti√≥n de Usuarios</h2>
          <div className="table-container">
            <table>
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Nombre</th>
                  <th>Rol</th>
                  <th>Turno</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {usuarios.map(usuario => (
                  <tr key={usuario.id}>
                    <td>{usuario.username}</td>
                    <td>{usuario.nombre_completo}</td>
                    <td><span className={`user-badge ${usuario.rol}`}>{usuario.rol}</span></td>
                    <td>{usuario.turno || <span style={{color: '#a0aec0'}}>Todos</span>}</td>
                    <td><span className={`badge ${usuario.activo ? 'badge-contestada' : 'badge-pendiente'}`}>{usuario.activo ? 'Activo' : 'Inactivo'}</span></td>
                    <td>
                      <button className="btn btn-primary" style={{fontSize: '12px', padding: '6px 12px'}} onClick={() => setUsuarioEditar(usuario)}>
                        ‚úèÔ∏è Editar
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {usuarioEditar && (
            <ModalEditarUsuario
              usuario={usuarioEditar}
              onClose={() => setUsuarioEditar(null)}
              onGuardar={() => {
                setUsuarioEditar(null);
                onRecargar();
                alert('Usuario actualizado');
              }}
            />
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
