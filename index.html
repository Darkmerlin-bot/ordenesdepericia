<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gesti√≥n de Pericias Forenses</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #1e3a8a;
      --primary-dark: #1e40af;
      --secondary: #dc2626;
      --success: #16a34a;
      --warning: #ea580c;
      --danger: #dc2626;
      --bg-main: #f8fafc;
      --bg-card: #ffffff;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-main);
      color: var(--text-primary);
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 24px;
      margin-bottom: 32px;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 16px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-secondary {
      background: var(--text-secondary);
      color: white;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid white;
      color: white;
    }

    .btn-outline:hover {
      background: white;
      color: var(--primary);
    }

    .card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .card-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-control {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
    }

    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }

    select.form-control {
      cursor: pointer;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    }

    .login-card {
      background: white;
      border-radius: 16px;
      padding: 48px;
      box-shadow: var(--shadow-lg);
      max-width: 450px;
      width: 100%;
    }

    .login-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 32px;
      text-align: center;
      color: var(--primary);
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      background: var(--bg-main);
      padding: 6px;
      border-radius: 10px;
    }

    .tab {
      flex: 1;
      padding: 10px 16px;
      border: none;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      color: var(--text-secondary);
    }

    .tab.active {
      background: white;
      color: var(--primary);
      box-shadow: var(--shadow);
    }

    .pericia-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      border: 2px solid var(--border);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .pericia-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .pericia-card.urgente {
      border-color: var(--danger);
      background: linear-gradient(to right, #fff 0%, #fef2f2 100%);
    }

    .pericia-card.sin-respuesta {
      border-color: var(--warning);
      border-width: 3px;
    }

    .pericia-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 16px;
    }

    .pericia-info {
      flex: 1;
    }

    .pericia-sgsp {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .pericia-fiscalia {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .pericia-detalles {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    .detalle-item {
      font-size: 13px;
    }

    .detalle-label {
      color: var(--text-secondary);
      font-weight: 500;
    }

    .detalle-valor {
      color: var(--text-primary);
      font-weight: 600;
    }

    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-pendiente {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-proceso {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge-contestada {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-urgente {
      background: #fee2e2;
      color: #991b1b;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .usuarios-asignados {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .usuario-tag {
      background: var(--primary);
      color: white;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      background: var(--bg-main);
      color: var(--danger);
    }

    .alert {
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
    }

    .alert-success {
      background: #d1fae5;
      color: #065f46;
      border-left: 4px solid var(--success);
    }

    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border-left: 4px solid var(--danger);
    }

    .alert-warning {
      background: #fed7aa;
      color: #9a3412;
      border-left: 4px solid var(--warning);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }

    .stat-value {
      font-size: 42px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .checkbox-item:hover {
      border-color: var(--primary);
      background: var(--bg-main);
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-state-text {
      font-size: 18px;
      font-weight: 500;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      font-size: 18px;
      color: var(--text-secondary);
    }

    .spinner {
      border: 4px solid var(--border);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-right: 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
    }

    .contestacion-item {
      background: var(--bg-main);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 4px solid var(--success);
    }

    .contestacion-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .contestacion-texto {
      color: var(--text-primary);
      line-height: 1.6;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }

      .header-actions {
        width: 100%;
        flex-direction: column;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // ============================================
    // CONFIGURACI√ìN DE SUPABASE
    // ============================================
    const SUPABASE_URL = 'https://dhpwdkysrjjsagtiqwmz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRocHdka3lzcmpqc2FndGlxd216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MDcwMTMsImV4cCI6MjA4NjQ4MzAxM30.L4j6986BRq7ghpleZFh3GJqt5MfaMsRBwTDP3Ubhm90';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================
    // COMPONENTE DE LOGIN
    // ============================================
    function Login() {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleLogin = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        try {
          // Buscar el email del usuario por username
          const { data: usuarioData, error: usuarioError } = await supabase
            .from('usuarios')
            .select('email, activo')
            .eq('username', username)
            .single();

          if (usuarioError || !usuarioData) {
            throw new Error('Usuario no encontrado');
          }

          if (!usuarioData.activo) {
            throw new Error('Usuario inactivo. Contacte al administrador.');
          }

          // Iniciar sesi√≥n con el email
          const { data, error } = await supabase.auth.signInWithPassword({
            email: usuarioData.email,
            password
          });

          if (error) throw error;
          
          // La sesi√≥n se guardar√° autom√°ticamente y onAuthStateChange se encargar√° del resto
          // No necesitamos llamar a onLogin aqu√≠
        } catch (err) {
          setError(err.message);
          setLoading(false);
        }
      };

      return (
        <div className="login-container">
          <div className="login-card">
            <h1 className="login-title">üîí Sistema de Pericias</h1>
            {error && (
              <div className="alert alert-error">‚ö†Ô∏è {error}</div>
            )}
            <form onSubmit={handleLogin}>
              <div className="form-group">
                <label className="form-label">Usuario</label>
                <input
                  type="text"
                  className="form-control"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  required
                  placeholder="usuario"
                  autoComplete="username"
                />
              </div>
              <div className="form-group">
                <label className="form-label">Contrase√±a</label>
                <input
                  type="password"
                  className="form-control"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  autoComplete="current-password"
                />
              </div>
              <button type="submit" className="btn btn-primary" style={{ width: '100%' }} disabled={loading}>
                {loading ? 'Ingresando...' : 'Ingresar'}
              </button>
            </form>
          </div>
        </div>
      );
    }

    // ============================================
    // COMPONENTE DE FORMULARIO NUEVA PERICIA
    // ============================================
    function FormularioPericia({ usuarios, onSuccess, onCancel }) {
      const [formData, setFormData] = useState({
        fecha: new Date().toISOString().split('T')[0],
        hora: new Date().toTimeString().split(' ')[0].substring(0, 5),
        numero_sgsp: '',
        pericia_solicitada: '',
        fiscalia: '1er Turno',
        plazo: '',
        numero_novedad: '',
        usuarios_asignados: []
      });
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const fiscalias = [
        '1er Turno',
        '2do Turno',
        '3er Turno',
        '4to Turno',
        '5to Turno',
        '1er Turno Delitos Sexuales',
        '2do Turno Delitos Sexuales'
      ];

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        if (formData.usuarios_asignados.length === 0) {
          setError('Debe asignar al menos un usuario');
          setLoading(false);
          return;
        }

        try {
          // Obtener usuario actual
          const { data: { user } } = await supabase.auth.getUser();

          // Insertar pericia
          const { data: pericia, error: periciaError } = await supabase
            .from('pericias')
            .insert({
              fecha: formData.fecha,
              hora: formData.hora,
              numero_sgsp: formData.numero_sgsp,
              pericia_solicitada: formData.pericia_solicitada,
              fiscalia: formData.fiscalia,
              plazo: formData.plazo,
              numero_novedad: formData.numero_novedad,
              creado_por: user.id
            })
            .select()
            .single();

          if (periciaError) throw periciaError;

          // Insertar asignaciones
          const asignaciones = formData.usuarios_asignados.map(userId => ({
            pericia_id: pericia.id,
            usuario_id: userId
          }));

          const { error: asignacionError } = await supabase
            .from('asignaciones')
            .insert(asignaciones);

          if (asignacionError) throw asignacionError;

          onSuccess();
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const toggleUsuario = (userId) => {
        setFormData(prev => ({
          ...prev,
          usuarios_asignados: prev.usuarios_asignados.includes(userId)
            ? prev.usuarios_asignados.filter(id => id !== userId)
            : [...prev.usuarios_asignados, userId]
        }));
      };

      return (
        <form onSubmit={handleSubmit}>
          {error && <div className="alert alert-error">‚ö†Ô∏è {error}</div>}

          <div className="form-row">
            <div className="form-group">
              <label className="form-label">Fecha</label>
              <input
                type="date"
                className="form-control"
                value={formData.fecha}
                onChange={(e) => setFormData({ ...formData, fecha: e.target.value })}
                required
              />
            </div>
            <div className="form-group">
              <label className="form-label">Hora</label>
              <input
                type="time"
                className="form-control"
                value={formData.hora}
                onChange={(e) => setFormData({ ...formData, hora: e.target.value })}
                required
              />
            </div>
          </div>

          <div className="form-group">
            <label className="form-label">N√∫mero SGSP</label>
            <input
              type="text"
              className="form-control"
              value={formData.numero_sgsp}
              onChange={(e) => setFormData({ ...formData, numero_sgsp: e.target.value })}
              required
              placeholder="Ej: 2025-123-456"
            />
          </div>

          <div className="form-group">
            <label className="form-label">Pericia Solicitada</label>
            <textarea
              className="form-control"
              value={formData.pericia_solicitada}
              onChange={(e) => setFormData({ ...formData, pericia_solicitada: e.target.value })}
              required
              placeholder="Describa la pericia solicitada..."
            />
          </div>

          <div className="form-row">
            <div className="form-group">
              <label className="form-label">Fiscal√≠a</label>
              <select
                className="form-control"
                value={formData.fiscalia}
                onChange={(e) => setFormData({ ...formData, fiscalia: e.target.value })}
                required
              >
                {fiscalias.map(f => (
                  <option key={f} value={f}>{f}</option>
                ))}
              </select>
            </div>
            <div className="form-group">
              <label className="form-label">Plazo</label>
              <input
                type="date"
                className="form-control"
                value={formData.plazo}
                onChange={(e) => setFormData({ ...formData, plazo: e.target.value })}
                required
              />
            </div>
          </div>

          <div className="form-group">
            <label className="form-label">N√∫mero de Novedad</label>
            <input
              type="text"
              className="form-control"
              value={formData.numero_novedad}
              onChange={(e) => setFormData({ ...formData, numero_novedad: e.target.value })}
              required
              placeholder="Ej: NOV-2025-001"
            />
          </div>

          <div className="form-group">
            <label className="form-label">Asignar a Usuarios</label>
            <div className="checkbox-group">
              {usuarios.map(usuario => (
                <label key={usuario.id} className="checkbox-item">
                  <input
                    type="checkbox"
                    checked={formData.usuarios_asignados.includes(usuario.id)}
                    onChange={() => toggleUsuario(usuario.id)}
                  />
                  <span>{usuario.nombre_completo}</span>
                </label>
              ))}
            </div>
          </div>

          <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}>
            <button type="submit" className="btn btn-primary" disabled={loading}>
              {loading ? 'Guardando...' : '‚úÖ Crear Pericia'}
            </button>
            <button type="button" className="btn btn-secondary" onClick={onCancel}>
              Cancelar
            </button>
          </div>
        </form>
      );
    }

    // ============================================
    // COMPONENTE DE DETALLE PERICIA
    // ============================================
    function DetallePericia({ pericia, onClose, currentUser, onUpdate }) {
      const [contestacion, setContestacion] = useState({
        fecha_respuesta: new Date().toISOString().split('T')[0],
        hora_respuesta: new Date().toTimeString().split(' ')[0].substring(0, 5),
        contestacion: ''
      });
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [contestaciones, setContestaciones] = useState([]);

      useEffect(() => {
        cargarContestaciones();
      }, []);

      const cargarContestaciones = async () => {
        const { data } = await supabase
          .from('contestaciones')
          .select('*, usuario:usuarios(nombre_completo)')
          .eq('pericia_id', pericia.id)
          .order('created_at', { ascending: false });

        if (data) setContestaciones(data);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        try {
          const { data: usuarioData } = await supabase
            .from('usuarios')
            .select('id, nombre_completo')
            .eq('id', currentUser.id)
            .single();

          const { error } = await supabase
            .from('contestaciones')
            .insert({
              pericia_id: pericia.id,
              usuario_id: usuarioData.id,
              fecha_respuesta: contestacion.fecha_respuesta,
              hora_respuesta: contestacion.hora_respuesta,
              contestacion: `${contestacion.contestacion}\n\n‚Äî ${usuarioData.nombre_completo}`
            });

          if (error) throw error;

          // Reproducir sonido de √©xito
          const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUQ0PVqzn7q1aGAxFo+LzwWwhBSuAzPLaizsIGGS57OmhUQ0RY7Ts7LBaGQxGpOPzw24eBi6CzvPajT4HHnHD8OOgVBEMUq3o76tcGQ1KpuT0vHEiBSuA0PPehjwJH3PG8OWhVhINUq/p76xbGgxIouL0wXAeBi+Dz/LaizsJH3TH8OSgVRIMU7Do8LBcGgxJo+P0wG8dBi+Dz/LbizsJHnPH8OSgVRIMU7Dp8K9dGgtJo+P0wG4dBi+D0fLaizsJHnPH8OShVBIMUrDo8K9dGgtJouP0wG4dBi+D0fLaizsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG4dBi+Dz/LajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG4dBi+Dz/LajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+D');
          audio.play().catch(() => {});

          setContestacion({
            fecha_respuesta: new Date().toISOString().split('T')[0],
            hora_respuesta: new Date().toTimeString().split(' ')[0].substring(0, 5),
            contestacion: ''
          });

          await cargarContestaciones();
          onUpdate();
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const diasRestantes = Math.ceil((new Date(pericia.plazo) - new Date()) / (1000 * 60 * 60 * 24));
      const esUrgente = diasRestantes <= 2;

      return (
        <div className="modal">
          <div className="modal-content">
            <div className="modal-header">
              <h2 className="modal-title">üìã Detalle de Pericia</h2>
              <button className="close-btn" onClick={onClose}>√ó</button>
            </div>

            {esUrgente && (
              <div className="alert alert-warning">
                ‚ö†Ô∏è URGENTE: Quedan {diasRestantes} d√≠a{diasRestantes !== 1 ? 's' : ''} para el plazo
              </div>
            )}

            <div className="card">
              <div className="pericia-detalles">
                <div className="detalle-item">
                  <div className="detalle-label">SGSP</div>
                  <div className="detalle-valor">{pericia.numero_sgsp}</div>
                </div>
                <div className="detalle-item">
                  <div className="detalle-label">Fiscal√≠a</div>
                  <div className="detalle-valor">{pericia.fiscalia}</div>
                </div>
                <div className="detalle-item">
                  <div className="detalle-label">Fecha</div>
                  <div className="detalle-valor">{pericia.fecha}</div>
                </div>
                <div className="detalle-item">
                  <div className="detalle-label">Hora</div>
                  <div className="detalle-valor">{pericia.hora}</div>
                </div>
                <div className="detalle-item">
                  <div className="detalle-label">Plazo</div>
                  <div className="detalle-valor">{pericia.plazo}</div>
                </div>
                <div className="detalle-item">
                  <div className="detalle-label">Novedad</div>
                  <div className="detalle-valor">{pericia.numero_novedad}</div>
                </div>
              </div>

              <div className="form-group">
                <div className="detalle-label">Pericia Solicitada</div>
                <div style={{ marginTop: '8px', padding: '12px', background: 'var(--bg-main)', borderRadius: '8px' }}>
                  {pericia.pericia_solicitada}
                </div>
              </div>
            </div>

            {contestaciones.length > 0 && (
              <div className="card">
                <div className="card-title">üí¨ Contestaciones Previas</div>
                {contestaciones.map(c => (
                  <div key={c.id} className="contestacion-item">
                    <div className="contestacion-header">
                      <span><strong>{c.usuario.nombre_completo}</strong></span>
                      <span>{c.fecha_respuesta} {c.hora_respuesta}</span>
                    </div>
                    <div className="contestacion-texto">{c.contestacion}</div>
                  </div>
                ))}
              </div>
            )}

            <div className="card">
              <div className="card-title">‚úçÔ∏è Nueva Contestaci√≥n</div>
              {error && <div className="alert alert-error">‚ö†Ô∏è {error}</div>}
              <form onSubmit={handleSubmit}>
                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Fecha Respuesta</label>
                    <input
                      type="date"
                      className="form-control"
                      value={contestacion.fecha_respuesta}
                      onChange={(e) => setContestacion({ ...contestacion, fecha_respuesta: e.target.value })}
                      required
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Hora Respuesta</label>
                    <input
                      type="time"
                      className="form-control"
                      value={contestacion.hora_respuesta}
                      onChange={(e) => setContestacion({ ...contestacion, hora_respuesta: e.target.value })}
                      required
                    />
                  </div>
                </div>

                <div className="form-group">
                  <label className="form-label">Contestaci√≥n</label>
                  <textarea
                    className="form-control"
                    value={contestacion.contestacion}
                    onChange={(e) => setContestacion({ ...contestacion, contestacion: e.target.value })}
                    required
                    placeholder="Escriba su contestaci√≥n..."
                  />
                </div>

                <button type="submit" className="btn btn-success" disabled={loading}>
                  {loading ? 'Guardando...' : '‚úÖ Guardar Contestaci√≥n'}
                </button>
              </form>
            </div>
          </div>
        </div>
      );
    }

    // ============================================
    // COMPONENTE DE GESTI√ìN DE USUARIOS (ADMIN)
    // ============================================
    function GestionUsuarios({ usuarioActual, onUpdate }) {
      const [usuarios, setUsuarios] = useState([]);
      const [loading, setLoading] = useState(true);
      const [editando, setEditando] = useState(null);
      const [formData, setFormData] = useState({ nombre_completo: '', rol: 'usuario', activo: true });
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');

      useEffect(() => {
        cargarUsuarios();
      }, []);

      const cargarUsuarios = async () => {
        setLoading(true);
        const { data, error } = await supabase
          .from('usuarios')
          .select('*')
          .order('nombre_completo');

        if (data) setUsuarios(data);
        if (error) setError(error.message);
        setLoading(false);
      };

      const handleEdit = (usuario) => {
        setEditando(usuario.id);
        setFormData({
          username: usuario.username,
          nombre_completo: usuario.nombre_completo,
          rol: usuario.rol,
          activo: usuario.activo
        });
        setError('');
        setSuccess('');
      };

      const handleSave = async (usuarioId) => {
        setError('');
        setSuccess('');

        try {
          const { error } = await supabase
            .from('usuarios')
            .update({
              username: formData.username,
              nombre_completo: formData.nombre_completo,
              rol: formData.rol,
              activo: formData.activo
            })
            .eq('id', usuarioId);

          if (error) throw error;

          setSuccess('Usuario actualizado correctamente');
          setEditando(null);
          await cargarUsuarios();
          if (onUpdate) onUpdate();
          
          setTimeout(() => setSuccess(''), 3000);
        } catch (err) {
          setError(err.message);
        }
      };

      const handleCancel = () => {
        setEditando(null);
        setError('');
        setSuccess('');
      };

      if (loading) {
        return (
          <div className="loading">
            <div className="spinner"></div>
            Cargando usuarios...
          </div>
        );
      }

      return (
        <div className="card">
          <div className="card-title">üë• Gesti√≥n de Usuarios</div>
          
          {error && <div className="alert alert-error">‚ö†Ô∏è {error}</div>}
          {success && <div className="alert alert-success">‚úÖ {success}</div>}

          <div style={{ overflowX: 'auto' }}>
            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
              <thead>
                <tr style={{ borderBottom: '2px solid var(--border)', textAlign: 'left' }}>
                  <th style={{ padding: '12px' }}>Usuario</th>
                  <th style={{ padding: '12px' }}>Nombre Completo</th>
                  <th style={{ padding: '12px' }}>Email</th>
                  <th style={{ padding: '12px' }}>Rol</th>
                  <th style={{ padding: '12px' }}>Estado</th>
                  <th style={{ padding: '12px' }}>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {usuarios.map(usuario => (
                  <tr key={usuario.id} style={{ borderBottom: '1px solid var(--border)' }}>
                    <td style={{ padding: '12px', fontWeight: '600' }}>
                      {editando === usuario.id ? (
                        <input
                          type="text"
                          className="form-control"
                          value={formData.username}
                          onChange={(e) => setFormData({ ...formData, username: e.target.value })}
                          style={{ minWidth: '120px' }}
                          disabled={usuario.id === usuarioActual?.id}
                        />
                      ) : (
                        <span>
                          {usuario.username}
                          {usuario.id === usuarioActual?.id && (
                            <span style={{ marginLeft: '8px', fontSize: '12px', background: 'var(--primary)', color: 'white', padding: '2px 8px', borderRadius: '4px' }}>
                              T√∫
                            </span>
                          )}
                        </span>
                      )}
                    </td>
                    <td style={{ padding: '12px' }}>
                      {editando === usuario.id ? (
                        <input
                          type="text"
                          className="form-control"
                          value={formData.nombre_completo}
                          onChange={(e) => setFormData({ ...formData, nombre_completo: e.target.value })}
                          style={{ minWidth: '200px' }}
                        />
                      ) : (
                        <strong>{usuario.nombre_completo}</strong>
                      )}
                    </td>
                    <td style={{ padding: '12px', color: 'var(--text-secondary)', fontSize: '13px' }}>
                      {usuario.email}
                    </td>
                    <td style={{ padding: '12px' }}>
                      {editando === usuario.id ? (
                        <select
                          className="form-control"
                          value={formData.rol}
                          onChange={(e) => setFormData({ ...formData, rol: e.target.value })}
                          disabled={usuario.id === usuarioActual?.id}
                        >
                          <option value="usuario">Usuario</option>
                          <option value="administrador">Administrador</option>
                        </select>
                      ) : (
                        <span className={`badge ${usuario.rol === 'administrador' ? 'badge-proceso' : 'badge-pendiente'}`}>
                          {usuario.rol === 'administrador' ? 'üëë Admin' : 'üë§ Usuario'}
                        </span>
                      )}
                    </td>
                    <td style={{ padding: '12px' }}>
                      {editando === usuario.id ? (
                        <label style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                          <input
                            type="checkbox"
                            checked={formData.activo}
                            onChange={(e) => setFormData({ ...formData, activo: e.target.checked })}
                            disabled={usuario.id === usuarioActual?.id}
                          />
                          <span>Activo</span>
                        </label>
                      ) : (
                        <span className={`badge ${usuario.activo ? 'badge-contestada' : 'badge-urgente'}`}>
                          {usuario.activo ? '‚úÖ Activo' : '‚ùå Inactivo'}
                        </span>
                      )}
                    </td>
                    <td style={{ padding: '12px' }}>
                      {editando === usuario.id ? (
                        <div style={{ display: 'flex', gap: '8px' }}>
                          <button
                            className="btn btn-success"
                            onClick={() => handleSave(usuario.id)}
                            style={{ padding: '6px 12px', fontSize: '13px' }}
                          >
                            ‚úÖ Guardar
                          </button>
                          <button
                            className="btn btn-secondary"
                            onClick={handleCancel}
                            style={{ padding: '6px 12px', fontSize: '13px' }}
                          >
                            ‚úñÔ∏è Cancelar
                          </button>
                        </div>
                      ) : (
                        <button
                          className="btn btn-primary"
                          onClick={() => handleEdit(usuario)}
                          style={{ padding: '6px 12px', fontSize: '13px' }}
                        >
                          ‚úèÔ∏è Editar
                        </button>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          <div style={{ marginTop: '24px', padding: '16px', background: 'var(--bg-main)', borderRadius: '8px', fontSize: '14px', color: 'var(--text-secondary)' }}>
            <strong>‚ÑπÔ∏è Informaci√≥n:</strong>
            <ul style={{ marginTop: '8px', marginLeft: '20px' }}>
              <li>Los <strong>Administradores</strong> pueden gestionar usuarios y ver todas las pericias del sistema</li>
              <li>Los <strong>Usuarios</strong> pueden crear pericias, ver sus pericias asignadas y contestarlas</li>
              <li><strong>Todos</strong> pueden crear nuevas pericias y asignar usuarios</li>
              <li>No puedes cambiar tu propio nombre de usuario ni desactivarte</li>
              <li>Los cambios se reflejan inmediatamente en el sistema</li>
            </ul>
          </div>
        </div>
      );
    }

    // ============================================
    // COMPONENTE PRINCIPAL
    // ============================================
    function App() {
      const [user, setUser] = useState(null);
      const [usuarioActual, setUsuarioActual] = useState(null);
      const [usuarios, setUsuarios] = useState([]);
      const [pericias, setPericias] = useState([]);
      const [loading, setLoading] = useState(true);
      const [vistaActual, setVistaActual] = useState('mis-pericias');
      const [mostrarFormulario, setMostrarFormulario] = useState(false);
      const [periciaSeleccionada, setPericiaSeleccionada] = useState(null);
      const [stats, setStats] = useState({ total: 0, pendientes: 0, enProceso: 0, contestadas: 0 });

      useEffect(() => {
        console.log('üîµ 1. useEffect - INICIANDO');
        
        // Timeout de seguridad: forzar loading=false despu√©s de 10 segundos
        const timeoutSeguridad = setTimeout(() => {
          console.log('‚ö†Ô∏è TIMEOUT DE SEGURIDAD - Forzando setLoading(false)');
          setLoading(false);
        }, 10000);
        
        // Inicializar y verificar sesi√≥n
        const init = async () => {
          console.log('üîµ 2. init() - Llamando getSession...');
          try {
            const { data: { session } } = await supabase.auth.getSession();
            console.log('üîµ 3. getSession completado. Sesi√≥n:', session ? 'S√ç' : 'NO');
            
            if (session?.user) {
              console.log('üîµ 4. Usuario encontrado:', session.user.email);
              setUser(session.user);
              
              console.log('üîµ 5. Cargando datos de tabla usuarios...');
              const { data: userData } = await supabase
                .from('usuarios')
                .select('*')
                .eq('id', session.user.id)
                .maybeSingle();
              
              console.log('üîµ 6. Datos usuario:', userData ? `${userData.username} (${userData.rol})` : 'NO ENCONTRADO');
              
              if (userData) {
                setUsuarioActual(userData);
              }
            } else {
              console.log('üîµ 4. No hay sesi√≥n activa');
            }
          } catch (error) {
            console.error('üî¥ ERROR en init():', error);
          } finally {
            console.log('üü¢ 7. FINALLY - setLoading(false)');
            clearTimeout(timeoutSeguridad);
            setLoading(false);
          }
        };
        
        init();
        
        console.log('üîµ 8. Configurando onAuthStateChange...');
        
        // Escuchar cambios de autenticaci√≥n
        const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
          console.log('üîµ AUTH EVENT:', event);
          
          if (event === 'SIGNED_IN' && session?.user) {
            console.log('üîµ Login detectado:', session.user.email);
            setUser(session.user);
            
            const { data: userData } = await supabase
              .from('usuarios')
              .select('*')
              .eq('id', session.user.id)
              .maybeSingle();
            
            if (userData) {
              console.log('üîµ Usuario cargado:', userData.username, userData.rol);
              setUsuarioActual(userData);
            }
            
            // Pedir permiso de notificaciones
            if ('Notification' in window && Notification.permission === 'default') {
              Notification.requestPermission().catch(() => {});
            }
          } else if (event === 'SIGNED_OUT') {
            console.log('üîµ Logout detectado');
            setUser(null);
            setUsuarioActual(null);
          }
        });
        
        console.log('üîµ 9. onAuthStateChange configurado');
        
        return () => {
          console.log('üîµ 10. Cleanup - unsubscribe');
          clearTimeout(timeoutSeguridad);
          subscription?.unsubscribe();
        };
      }, []);

      useEffect(() => {
        if (user && usuarioActual) {
          cargarDatos();
          const interval = setInterval(cargarDatos, 30000); // Actualizar cada 30 segundos
          return () => clearInterval(interval);
        }
      }, [user, usuarioActual, vistaActual]);

      const cargarDatos = async () => {
        await Promise.all([
          cargarUsuarios(),
          vistaActual === 'mis-pericias' ? cargarMisPericias() : cargarTodasPericias()
        ]);
      };

      const cargarUsuarios = async () => {
        const { data } = await supabase
          .from('usuarios')
          .select('*')
          .eq('activo', true)
          .order('nombre_completo');
        
        if (data) setUsuarios(data);
      };

      const cargarMisPericias = async () => {
        // Obtener usuario actual de la tabla usuarios
        const { data: usuarioActual } = await supabase
          .from('usuarios')
          .select('id')
          .eq('id', user.id)
          .single();

        if (!usuarioActual) return;

        // Obtener pericias asignadas
        const { data: asignaciones } = await supabase
          .from('asignaciones')
          .select('pericia_id')
          .eq('usuario_id', usuarioActual.id);

        if (!asignaciones || asignaciones.length === 0) {
          setPericias([]);
          setStats({ total: 0, pendientes: 0, enProceso: 0, contestadas: 0 });
          return;
        }

        const periciaIds = asignaciones.map(a => a.pericia_id);

        // Obtener pericias completas
        const { data: periciasData } = await supabase
          .from('pericias')
          .select(`
            *,
            asignaciones(usuario_id),
            contestaciones(id, usuario_id)
          `)
          .in('id', periciaIds)
          .order('plazo', { ascending: true });

        if (periciasData) {
          // Marcar pericias sin contestar del usuario actual
          const periciasConInfo = periciasData.map(p => ({
            ...p,
            contestada_por_mi: p.contestaciones?.some(c => c.usuario_id === usuarioActual.id) || false,
            total_contestaciones: p.contestaciones?.length || 0,
            total_asignaciones: p.asignaciones?.length || 0
          }));

          setPericias(periciasConInfo);

          // Calcular estad√≠sticas
          setStats({
            total: periciasConInfo.length,
            pendientes: periciasConInfo.filter(p => p.estado === 'pendiente').length,
            enProceso: periciasConInfo.filter(p => p.estado === 'en_proceso').length,
            contestadas: periciasConInfo.filter(p => p.estado === 'contestada').length
          });

          // Verificar alertas de plazo
          periciasConInfo.forEach(p => {
            const diasRestantes = Math.ceil((new Date(p.plazo) - new Date()) / (1000 * 60 * 60 * 24));
            if (diasRestantes <= 2 && !p.contestada_por_mi) {
              mostrarAlertaPlazo(p, diasRestantes);
            }
          });
        }
      };

      const cargarTodasPericias = async () => {
        const { data } = await supabase
          .from('pericias')
          .select(`
            *,
            asignaciones(usuario_id, usuarios(nombre_completo)),
            contestaciones(id)
          `)
          .order('created_at', { ascending: false });

        if (data) {
          const periciasConInfo = data.map(p => ({
            ...p,
            total_contestaciones: p.contestaciones?.length || 0,
            total_asignaciones: p.asignaciones?.length || 0,
            usuarios_asignados: p.asignaciones?.map(a => a.usuarios.nombre_completo) || []
          }));

          setPericias(periciasConInfo);

          setStats({
            total: periciasConInfo.length,
            pendientes: periciasConInfo.filter(p => p.estado === 'pendiente').length,
            enProceso: periciasConInfo.filter(p => p.estado === 'en_proceso').length,
            contestadas: periciasConInfo.filter(p => p.estado === 'contestada').length
          });
        }
      };

      const mostrarAlertaPlazo = (pericia, dias) => {
        // Reproducir sonido de alerta
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUQ0PVqzn7q1aGAxFo+LzwWwhBSuAzPLaizsIGGS57OmhUQ0RY7Ts7LBaGQxGpOPzw24eBi6CzvPajT4HHnHD8OOgVBEMUq3o76tcGQ1KpuT0vHEiBSuA0PPehjwJH3PG8OWhVhINUq/p76xbGgxIouL0wXAeBi+Dz/LaizsJH3TH8OSgVRIMU7Do8LBcGgxJo+P0wG8dBi+Dz/LbizsJHnPH8OSgVRIMU7Dp8K9dGgtJo+P0wG4dBi+Dz/LbizsJHnPH8OShVBIMUrDo8K9dGgtJo+P0wG4dBi+D0fLaizsJHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG4dBi+D0fLaizsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG4dBi+Dz/LajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG4dBi+Dz/LajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+Dz/PajDsIHnPH8OSgVRIMU7Dp8K9dGgtJouP0wG8cBi+D');
        audio.play().catch(() => {});

        // Mostrar notificaci√≥n del navegador si est√° permitido
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('‚ö†Ô∏è Plazo Pr√≥ximo', {
            body: `SGSP ${pericia.numero_sgsp} vence en ${dias} d√≠a${dias !== 1 ? 's' : ''}`,
            icon: 'üîî',
            requireInteraction: true
          });
        }
      };

      const handleLogout = async () => {
        await supabase.auth.signOut();
        setUser(null);
      };

      if (loading) {
        return (
          <div className="loading">
            <div className="spinner"></div>
            Cargando sistema...
          </div>
        );
      }

      if (!user) {
        return <Login />;
      }

      return (
        <div className="container">
          <div className="header">
            <h1>üî¨ Sistema de Gesti√≥n de Pericias</h1>
            <div className="header-actions">
              <div className="user-info">
                <span>{usuarioActual?.rol === 'administrador' ? 'üëë' : 'üë§'}</span>
                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-start' }}>
                  <span style={{ fontWeight: '600' }}>{usuarioActual?.nombre_completo || user.email}</span>
                  <span style={{ fontSize: '12px', opacity: '0.8' }}>
                    {usuarioActual?.rol === 'administrador' ? 'Administrador' : 'Usuario'}
                  </span>
                </div>
              </div>
              <button className="btn btn-outline" onClick={handleLogout}>
                üö™ Salir
              </button>
            </div>
          </div>

          <div className="stats-grid">
            <div className="stat-card" style={{ background: 'linear-gradient(135deg, #3b82f6 0%, #1e40af 100%)' }}>
              <div className="stat-value">{stats.total}</div>
              <div className="stat-label">Total Pericias</div>
            </div>
            <div className="stat-card" style={{ background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' }}>
              <div className="stat-value">{stats.pendientes}</div>
              <div className="stat-label">Pendientes</div>
            </div>
            <div className="stat-card" style={{ background: 'linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%)' }}>
              <div className="stat-value">{stats.enProceso}</div>
              <div className="stat-label">En Proceso</div>
            </div>
            <div className="stat-card" style={{ background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)' }}>
              <div className="stat-value">{stats.contestadas}</div>
              <div className="stat-label">Contestadas</div>
            </div>
          </div>

          <div className="card">
            <div className="tabs">
              <button
                className={`tab ${vistaActual === 'mis-pericias' ? 'active' : ''}`}
                onClick={() => setVistaActual('mis-pericias')}
              >
                üì• Mis Pericias Asignadas
              </button>
              <button
                className={`tab ${vistaActual === 'crear' ? 'active' : ''}`}
                onClick={() => setVistaActual('crear')}
              >
                ‚ûï Nueva Pericia
              </button>
              {usuarioActual?.rol === 'administrador' && (
                <>
                  <button
                    className={`tab ${vistaActual === 'todas' ? 'active' : ''}`}
                    onClick={() => setVistaActual('todas')}
                  >
                    üìä Todas las Pericias
                  </button>
                  <button
                    className={`tab ${vistaActual === 'usuarios' ? 'active' : ''}`}
                    onClick={() => setVistaActual('usuarios')}
                  >
                    üë• Gesti√≥n de Usuarios
                  </button>
                </>
              )}
            </div>

            {vistaActual === 'usuarios' && usuarioActual?.rol === 'administrador' && (
              <GestionUsuarios usuarioActual={usuarioActual} onUpdate={cargarDatos} />
            )}

            {vistaActual === 'crear' && (
              <FormularioPericia
                usuarios={usuarios}
                onSuccess={() => {
                  setVistaActual('mis-pericias');
                  cargarDatos();
                }}
                onCancel={() => setVistaActual('mis-pericias')}
              />
            )}

            {vistaActual !== 'crear' && vistaActual !== 'usuarios' && (
              <>
                {pericias.length === 0 ? (
                  <div className="empty-state">
                    <div className="empty-state-icon">üìã</div>
                    <div className="empty-state-text">
                      {vistaActual === 'mis-pericias' 
                        ? 'No tienes pericias asignadas' 
                        : 'No hay pericias registradas'}
                    </div>
                  </div>
                ) : (
                  pericias.map(pericia => {
                    const diasRestantes = Math.ceil((new Date(pericia.plazo) - new Date()) / (1000 * 60 * 60 * 24));
                    const esUrgente = diasRestantes <= 2;
                    const sinContestar = vistaActual === 'mis-pericias' && !pericia.contestada_por_mi;

                    return (
                      <div
                        key={pericia.id}
                        className={`pericia-card ${esUrgente ? 'urgente' : ''} ${sinContestar ? 'sin-respuesta' : ''}`}
                        onClick={() => setPericiaSeleccionada(pericia)}
                      >
                        <div className="pericia-header">
                          <div className="pericia-info">
                            <div className="pericia-sgsp">{pericia.numero_sgsp}</div>
                            <div className="pericia-fiscalia">{pericia.fiscalia}</div>
                          </div>
                          <div style={{ display: 'flex', gap: '8px' }}>
                            <span className={`badge badge-${pericia.estado === 'pendiente' ? 'pendiente' : pericia.estado === 'en_proceso' ? 'proceso' : 'contestada'}`}>
                              {pericia.estado === 'pendiente' ? '‚è≥ Pendiente' : 
                               pericia.estado === 'en_proceso' ? 'üîÑ En Proceso' : '‚úÖ Contestada'}
                            </span>
                            {esUrgente && <span className="badge badge-urgente">üö® URGENTE</span>}
                            {sinContestar && <span className="badge badge-urgente">‚ùó Sin Responder</span>}
                          </div>
                        </div>

                        <div className="pericia-detalles">
                          <div className="detalle-item">
                            <span className="detalle-label">Fecha:</span>{' '}
                            <span className="detalle-valor">{pericia.fecha}</span>
                          </div>
                          <div className="detalle-item">
                            <span className="detalle-label">Plazo:</span>{' '}
                            <span className="detalle-valor" style={{ color: esUrgente ? 'var(--danger)' : 'inherit' }}>
                              {pericia.plazo} ({diasRestantes} d√≠as)
                            </span>
                          </div>
                          <div className="detalle-item">
                            <span className="detalle-label">Novedad:</span>{' '}
                            <span className="detalle-valor">{pericia.numero_novedad}</span>
                          </div>
                          <div className="detalle-item">
                            <span className="detalle-label">Respuestas:</span>{' '}
                            <span className="detalle-valor">{pericia.total_contestaciones} / {pericia.total_asignaciones}</span>
                          </div>
                        </div>

                        <div style={{ marginTop: '12px', fontSize: '14px', color: 'var(--text-secondary)' }}>
                          {pericia.pericia_solicitada.substring(0, 150)}
                          {pericia.pericia_solicitada.length > 150 ? '...' : ''}
                        </div>

                        {vistaActual === 'todas' && pericia.usuarios_asignados && (
                          <div className="usuarios-asignados">
                            {pericia.usuarios_asignados.map((nombre, idx) => (
                              <span key={idx} className="usuario-tag">{nombre}</span>
                            ))}
                          </div>
                        )}
                      </div>
                    );
                  })
                )}
              </>
            )}
          </div>

          {periciaSeleccionada && (
            <DetallePericia
              pericia={periciaSeleccionada}
              currentUser={user}
              onClose={() => setPericiaSeleccionada(null)}
              onUpdate={() => {
                cargarDatos();
                setPericiaSeleccionada(null);
              }}
            />
          )}
        </div>
      );
    }

    // Las notificaciones se solicitar√°n cuando el usuario haga login
    // (el permiso se debe pedir con interacci√≥n del usuario)

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
